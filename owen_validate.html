<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Owen Family ‚Äî Validate &amp; Discover</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,500&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f0e8; --bg-card: #faf7f2; --bg-dark: #eee8db;
  --accent: #8b6914; --accent-light: #c4a44a; --accent-glow: rgba(139,105,20,0.12);
  --text: #2c2418; --text-muted: #6b5d4d; --text-light: #9a8b78;
  --border: #d9cdb8; --border-light: #e8dece;
  --success: #4a7c59; --success-bg: rgba(74,124,89,0.1);
  --warn: #b8860b; --warn-bg: rgba(184,134,11,0.1);
  --danger: #8b3a3a; --danger-bg: rgba(139,58,58,0.1);
  --info: #3a5f8b; --info-bg: rgba(58,95,139,0.1);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

.home-nav{background:var(--bg-card);padding:8px 16px;border-bottom:1px solid var(--border);}
.home-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);text-decoration:none;font-size:0.8rem;font-weight:500;transition:all .2s;}
.home-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent);transform:translateY(-1px);}

.site-header{background:linear-gradient(135deg,#2c2418 0%,#3d3224 50%,#2c2418 100%);padding:2.5rem 2rem 2rem;position:relative;}
.site-header::before{content:'';position:absolute;inset:0;background:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");}
.header-content{max-width:1100px;margin:0 auto;position:relative;z-index:1;}
.site-title{font-family:'Cormorant Garamond',serif;font-weight:300;font-size:2.5rem;color:#f5f0e8;}
.site-title span{color:var(--accent-light);font-weight:600;}
.site-subtitle{color:#9a8b78;font-size:0.95rem;margin-top:0.3rem;font-weight:300;max-width:700px;line-height:1.5;}

/* Hero stats */
.hero-stats{display:flex;gap:1px;background:rgba(255,255,255,0.06);border-radius:10px;overflow:hidden;margin-top:1.3rem;max-width:750px;}
.hero-stat{flex:1;padding:1rem 0.8rem;text-align:center;background:rgba(255,255,255,0.03);}
.hero-stat-value{font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:700;line-height:1;}
.hero-stat-value.red{color:#d4715a;}
.hero-stat-value.yellow{color:var(--accent-light);}
.hero-stat-value.green{color:#6aad7a;}
.hero-stat-label{font-size:0.7rem;color:#9a8b78;margin-top:0.25rem;text-transform:uppercase;letter-spacing:0.08em;}

.main-container{max-width:1100px;margin:0 auto;padding:2rem;}

/* Tabs */
.tab-nav{display:flex;gap:0.3rem;margin-bottom:1.5rem;flex-wrap:wrap;}
.tab-btn{font-family:'DM Sans',sans-serif;font-size:0.85rem;padding:0.55rem 1.1rem;border:1px solid var(--border);border-radius:8px;background:var(--bg-card);color:var(--text-muted);cursor:pointer;transition:all 0.15s;font-weight:500;display:flex;align-items:center;gap:0.4rem;}
.tab-btn:hover{background:var(--accent-glow);border-color:var(--accent);}
.tab-btn.active{background:var(--accent);color:#fff;border-color:var(--accent);}
.tab-badge{font-size:0.7rem;padding:0.1rem 0.4rem;border-radius:4px;font-weight:600;}
.tab-btn.active .tab-badge{background:rgba(255,255,255,0.25);color:#fff;}
.tab-badge.red{background:var(--danger-bg);color:var(--danger);}
.tab-badge.yellow{background:var(--warn-bg);color:var(--warn);}

.tab-content{display:none;}
.tab-content.active{display:block;}

/* Gap cards */
.gap-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:1rem;}
.gap-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;overflow:hidden;transition:border-color 0.2s,box-shadow 0.2s;}
.gap-card:hover{border-color:var(--accent-light);box-shadow:0 4px 16px var(--accent-glow);}
.gap-card-header{padding:1rem 1.2rem 0.7rem;display:flex;justify-content:space-between;align-items:flex-start;}
.gap-card-name{font-family:'Cormorant Garamond',serif;font-size:1.15rem;font-weight:600;color:var(--text);}
.gap-card-dates{font-size:0.82rem;color:var(--text-muted);margin-top:0.1rem;}
.gap-severity{font-size:0.68rem;font-weight:600;padding:0.15rem 0.5rem;border-radius:4px;text-transform:uppercase;letter-spacing:0.05em;}
.sev-high{background:var(--danger-bg);color:var(--danger);}
.sev-medium{background:var(--warn-bg);color:var(--warn);}
.sev-low{background:var(--info-bg);color:var(--info);}

.gap-card-body{padding:0 1.2rem 0.8rem;}
.gap-issues{display:flex;flex-direction:column;gap:0.35rem;}
.gap-issue{font-size:0.85rem;display:flex;align-items:flex-start;gap:0.4rem;color:var(--text-muted);}
.gap-issue-icon{flex-shrink:0;margin-top:0.1rem;}
.gap-issue-icon.missing{color:var(--danger);}
.gap-issue-icon.partial{color:var(--warn);}
.gap-issue-icon.note{color:var(--info);}

.gap-card-footer{padding:0.7rem 1.2rem;background:var(--bg);border-top:1px solid var(--border-light);display:flex;gap:0.5rem;flex-wrap:wrap;}
.gap-action{font-family:'DM Sans',sans-serif;font-size:0.78rem;padding:0.35rem 0.7rem;border:1px solid var(--border);border-radius:6px;background:var(--bg-card);color:var(--text-muted);cursor:pointer;transition:all 0.15s;font-weight:500;}
.gap-action:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-glow);}
.gap-action.primary{background:var(--accent);color:#fff;border-color:var(--accent);}
.gap-action.primary:hover{background:#a07a1a;}

/* Research panel (right drawer) */
.research-drawer{position:fixed;top:0;right:0;width:520px;max-width:95vw;height:100vh;background:var(--bg-card);border-left:1px solid var(--border);box-shadow:-8px 0 40px rgba(44,36,24,0.15);z-index:200;transform:translateX(100%);transition:transform 0.3s ease;display:flex;flex-direction:column;}
.research-drawer.open{transform:translateX(0);}
.drawer-backdrop{position:fixed;inset:0;background:rgba(44,36,24,0.3);z-index:190;display:none;}
.drawer-backdrop.active{display:block;}

.drawer-header{padding:1.3rem 1.5rem;background:linear-gradient(135deg,#2c2418,#3d3224);color:#f5f0e8;flex-shrink:0;}
.drawer-close{position:absolute;top:1rem;right:1.2rem;background:none;border:none;color:#9a8b78;font-size:1.3rem;cursor:pointer;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all 0.15s;}
.drawer-close:hover{color:#f5f0e8;background:rgba(255,255,255,0.1);}
.drawer-title{font-family:'Cormorant Garamond',serif;font-size:1.3rem;font-weight:600;}
.drawer-subtitle{font-size:0.85rem;color:var(--accent-light);margin-top:0.15rem;}

.drawer-body{flex:1;overflow-y:auto;padding:1.5rem;}

.drawer-loading{text-align:center;padding:3rem 1rem;}
.drawer-spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 1rem;}
@keyframes spin{to{transform:rotate(360deg);}}
.drawer-loading-text{color:var(--text-muted);font-size:0.9rem;}

.drawer-result{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:1.2rem;margin-bottom:1rem;}
.drawer-result-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.8rem;}
.drawer-result-title{font-family:'Cormorant Garamond',serif;font-size:1.15rem;font-weight:600;color:var(--text);}
.likelihood-badge{font-size:0.72rem;font-weight:600;padding:0.2rem 0.5rem;border-radius:4px;}
.likelihood-high{background:var(--success-bg);color:var(--success);}
.likelihood-medium{background:var(--warn-bg);color:var(--warn);}
.likelihood-low{background:var(--info-bg);color:var(--info);}
.drawer-result-details{font-size:0.85rem;line-height:1.6;color:var(--text-muted);}
.drawer-result-details strong{color:var(--text);}
.drawer-result-actions{display:flex;gap:0.5rem;margin-top:1rem;}
.drawer-action-btn{font-family:'DM Sans',sans-serif;font-size:0.8rem;padding:0.5rem 1rem;border:1px solid var(--border);border-radius:6px;background:var(--bg-card);color:var(--text-muted);cursor:pointer;transition:all 0.15s;font-weight:500;}
.drawer-action-btn:hover{border-color:var(--accent);color:var(--accent);}
.drawer-action-btn.accept{background:var(--success);color:#fff;border-color:var(--success);}
.drawer-action-btn.accept:hover{background:#3a5f44;}

.empty-state{text-align:center;padding:3rem 1rem;color:var(--text-muted);}
.empty-icon{font-size:3rem;margin-bottom:1rem;opacity:0.3;}
.empty-text{font-size:0.95rem;}

/* Export log */
.export-log{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:1rem;margin-top:1.5rem;font-family:monospace;font-size:0.8rem;white-space:pre-wrap;color:var(--text-muted);display:none;}
.export-log.active{display:block;}

.validation-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1.5rem;}
.vs-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:1.2rem;text-align:center;}
.vs-value{font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:700;line-height:1;}
.vs-label{font-size:0.78rem;color:var(--text-muted);margin-top:0.2rem;}

@media(max-width:768px){
  .site-title{font-size:2rem;}
  .hero-stats{flex-wrap:wrap;}
  .hero-stat{min-width:33%;}
  .gap-grid{grid-template-columns:1fr;}
  .research-drawer{width:100%;}
  .main-container{padding:1.5rem 1rem;}
}
</style>
<script src="data-loader.js"></script>
</head>
<body>

<div class="home-nav"><a href="index.html" class="home-btn">‚Üê Return to Home</a></div>

<header class="site-header">
  <div class="header-content">
    <h1 class="site-title">Validate &amp; <span>Discover</span></h1>
    <p class="site-subtitle">AI-powered gap analysis, relationship validation, and discovery of missing family members. Approve recommendations and export to Excel for manual review before adding to your Google Sheet database.</p>
    <div class="hero-stats" id="heroStats"></div>
  </div>
</header>

<main class="main-container">
  <div class="tab-nav" id="tabNav"></div>
  <div class="tab-content active" id="tab-gaps"></div>
  <div class="tab-content" id="tab-children"></div>
  <div class="tab-content" id="tab-one-parent"></div>
  <div class="tab-content" id="tab-no-spouse"></div>
  <div class="tab-content" id="tab-accepted"></div>
</main>

<div class="drawer-backdrop" id="drawerBackdrop" onclick="closeDrawer()"></div>
<div class="research-drawer" id="researchDrawer">
  <div class="drawer-header" style="position:relative;">
    <button class="drawer-close" onclick="closeDrawer()">&#10005;</button>
    <div class="drawer-title" id="drawerTitle">Research</div>
    <div class="drawer-subtitle" id="drawerSubtitle"></div>
  </div>
  <div class="drawer-body" id="drawerBody"></div>
</div>

<script>
// ===== DATA LOADING =====
let PEOPLE = [];
const peopleMap = {};

async function initValidation() {
  try {
    const db = owenFamilyDB;
    const data = await db.getData();
    
    if (!data.people || data.people.length === 0) {
      throw new Error('No records returned from database');
    }
    
    PEOPLE = data.people;
    PEOPLE.forEach(function(p){ peopleMap[p.id] = p; });
    
    // Run all analyses
    runGapAnalysis();
    renderHeroStats();
    renderTabs();
    renderOverview();
    renderedTabs['gaps'] = true;
    
  } catch (error) {
    console.error('Failed to load family data:', error);
    document.getElementById('heroStats').innerHTML = '<p style="color:var(--danger)">Unable to load family data. Please refresh the page.</p>';
  }
}

function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function pName(p){return p.fullName||p.firstName+' '+p.lastName;}

const branchColors = {Owen:'#b8860b',Wells:'#4682b4',Bonnie:'#b44a4a',Eastman:'#7a4a9a',Lunde:'#4a9a9a',Murphy:'#c4864a',Nelson:'#4a9a6a'};

// ===== GAP ANALYSIS ENGINE =====
var gaps = {
  missingMother: [],   // have father but no mother
  missingFather: [],   // have mother but no father
  missingBothParents: [], // have neither parent but are connected
  missingSpouse: [],   // have children but no spouse
  childrenGap: [],     // notes say more children than recorded
  noSpouseNoKids: [],  // dead-end nodes with no family links
};

function runGapAnalysis() {
  // Reset gaps
  gaps = {
    missingMother: [],
    missingFather: [],
    missingBothParents: [],
    missingSpouse: [],
    childrenGap: [],
    noSpouseNoKids: [],
  };

  // Analyze each person
  PEOPLE.forEach(function(p){
    var hasFather = p.fatherId && peopleMap[p.fatherId];
    var hasMother = p.motherId && peopleMap[p.motherId];
    var hasSpouse = p.spouseIds && p.spouseIds.length > 0;
    var hasChildren = p.childrenIds && p.childrenIds.length > 0;
    var isPre1950 = p.birthYear && p.birthYear < 1950;

    // Missing parents (only for people born before 1950, where records might exist)
    if(isPre1950){
      if(hasFather && !hasMother) gaps.missingMother.push(p);
      else if(!hasFather && hasMother) gaps.missingFather.push(p);
      else if(!hasFather && !hasMother && (hasChildren || hasSpouse || (p.siblingIds && p.siblingIds.length))) gaps.missingBothParents.push(p);
    }

    // Missing spouse (have children but no spouse recorded)
    if(hasChildren && !hasSpouse && isPre1950){
      gaps.missingSpouse.push(p);
    }

    // Check notes for "children" mentions
    if(p.notes && p.notes.toLowerCase().includes('children') && hasChildren){
      var notesText = p.notes.toLowerCase();
      var digitMatches = notesText.match(/\d+/g);
      if(digitMatches){
        var mentionedCount = Math.max(...digitMatches.map(Number));
        if(mentionedCount > p.childrenIds.length){
          gaps.childrenGap.push({person:p, mentioned:mentionedCount, recorded:p.childrenIds.length});
        }
      }
    }

    // Dead-end nodes (no parents, no spouse, no children)
    if(!hasFather && !hasMother && !hasSpouse && !hasChildren && isPre1950){
      gaps.noSpouseNoKids.push(p);
    }
  });
}

// ===== STATE =====
var activeTab = 'gaps';
var renderedTabs = {};
var acceptedChanges = [];

// ===== HERO STATS =====
function renderHeroStats(){
  var totalGaps = gaps.missingMother.length + gaps.missingFather.length + gaps.missingBothParents.length + gaps.missingSpouse.length;
  var highPriority = gaps.missingBothParents.length + gaps.missingSpouse.length;
  var mediumPriority = gaps.missingMother.length + gaps.missingFather.length;
  
  document.getElementById('heroStats').innerHTML = `
    <div class="hero-stat">
      <div class="hero-stat-value red">${totalGaps}</div>
      <div class="hero-stat-label">Total Gaps</div>
    </div>
    <div class="hero-stat">
      <div class="hero-stat-value yellow">${highPriority}</div>
      <div class="hero-stat-label">High Priority</div>
    </div>
    <div class="hero-stat">
      <div class="hero-stat-value green">${acceptedChanges.length}</div>
      <div class="hero-stat-label">Accepted</div>
    </div>
  `;
}

// ===== TABS =====
function renderTabs(){
  var tabs = [
    {id:'gaps', label:'Overview', count:null},
    {id:'children', label:'Missing Children', count:gaps.childrenGap.length, color:'yellow'},
    {id:'one-parent', label:'One Parent Missing', count:gaps.missingMother.length + gaps.missingFather.length, color:'yellow'},
    {id:'no-spouse', label:'Missing Spouse', count:gaps.missingSpouse.length, color:'red'},
    {id:'accepted', label:'Accepted Changes', count:acceptedChanges.length, color:'green'}
  ];
  
  var html = tabs.map(function(tab){
    var badge = tab.count != null ? `<span class="tab-badge ${tab.color||''}">${tab.count}</span>` : '';
    return `<button class="tab-btn ${tab.id===activeTab?'active':''}" onclick="switchTab('${tab.id}')">${tab.label}${badge}</button>`;
  }).join('');
  
  document.getElementById('tabNav').innerHTML = html;
}

function switchTab(tabId){
  activeTab = tabId;
  
  // Update tab buttons
  var btns = document.querySelectorAll('.tab-btn');
  btns.forEach(function(btn){btn.classList.remove('active');});
  btns.forEach(function(btn){
    if(btn.textContent.toLowerCase().includes(tabId.replace('-',' ').split(' ')[0])) btn.classList.add('active');
  });
  
  // Show/hide content
  var contents = document.querySelectorAll('.tab-content');
  contents.forEach(function(c){c.classList.remove('active');});
  document.getElementById('tab-'+tabId).classList.add('active');
  
  // Render if not yet rendered
  if(!renderedTabs[tabId]){
    renderTabContent(tabId);
    renderedTabs[tabId] = true;
  }
}

function renderTabContent(tabId){
  var container = document.getElementById('tab-'+tabId);
  
  if(tabId === 'gaps'){
    renderOverview();
  } else if(tabId === 'children'){
    renderChildrenGaps();
  } else if(tabId === 'one-parent'){
    renderOneParentGaps();
  } else if(tabId === 'no-spouse'){
    renderNoSpouseGaps();
  } else if(tabId === 'accepted'){
    renderAcceptedChanges();
  }
}

// ===== OVERVIEW =====
function renderOverview(){
  var html = '<div class="validation-summary">';
  html += `<div class="vs-card"><div class="vs-value" style="color:var(--danger)">${gaps.missingBothParents.length}</div><div class="vs-label">Both Parents Missing</div></div>`;
  html += `<div class="vs-card"><div class="vs-value" style="color:var(--warn)">${gaps.missingMother.length}</div><div class="vs-label">Missing Mother</div></div>`;
  html += `<div class="vs-card"><div class="vs-value" style="color:var(--warn)">${gaps.missingFather.length}</div><div class="vs-label">Missing Father</div></div>`;
  html += `<div class="vs-card"><div class="vs-value" style="color:var(--danger)">${gaps.missingSpouse.length}</div><div class="vs-label">Missing Spouse</div></div>`;
  html += `<div class="vs-card"><div class="vs-value" style="color:var(--info)">${gaps.childrenGap.length}</div><div class="vs-label">Potential Extra Children</div></div>`;
  html += '</div>';
  
  html += '<h3 style="font-family:\'Cormorant Garamond\',serif;font-size:1.5rem;margin-bottom:1rem;color:var(--accent)">High Priority Gaps</h3>';
  html += '<div class="gap-grid">';
  
  // Both parents missing
  gaps.missingBothParents.slice(0,6).forEach(function(p){
    html += renderGapCard(p, 'Both parents missing', 'high', [
      {icon:'‚ö†Ô∏è', text:'No father recorded', cls:'missing'},
      {icon:'‚ö†Ô∏è', text:'No mother recorded', cls:'missing'},
      {icon:'‚ÑπÔ∏è', text:'Has children or spouse - parents likely existed', cls:'note'}
    ]);
  });
  
  // Missing spouse
  gaps.missingSpouse.slice(0,6).forEach(function(p){
    var childCount = p.childrenIds ? p.childrenIds.length : 0;
    html += renderGapCard(p, 'Missing spouse', 'high', [
      {icon:'‚ö†Ô∏è', text:`Has ${childCount} child${childCount!==1?'ren':''} but no spouse`, cls:'missing'},
      {icon:'‚ÑπÔ∏è', text:'Spouse may have died young or records lost', cls:'note'}
    ]);
  });
  
  html += '</div>';
  document.getElementById('tab-gaps').innerHTML = html;
}

function renderGapCard(p, issue, severity, issues){
  var dates = [];
  if(p.birthYear) dates.push('b. '+p.birthYear);
  if(p.deathYear) dates.push('d. '+p.deathYear);
  var sevCls = severity==='high'?'sev-high':severity==='medium'?'sev-medium':'sev-low';
  
  var issuesHtml = issues.map(function(iss){
    return `<div class="gap-issue"><span class="gap-issue-icon ${iss.cls}">${iss.icon}</span><span>${iss.text}</span></div>`;
  }).join('');
  
  return `
    <div class="gap-card">
      <div class="gap-card-header">
        <div>
          <div class="gap-card-name">${esc(pName(p))}</div>
          <div class="gap-card-dates">${dates.join(' ¬∑ ')}</div>
        </div>
        <span class="gap-severity ${sevCls}">${severity}</span>
      </div>
      <div class="gap-card-body">
        <div class="gap-issues">${issuesHtml}</div>
      </div>
      <div class="gap-card-footer">
        <button class="gap-action primary" onclick="researchPerson('${p.id}','${esc(issue)}')">üîç Research</button>
        <button class="gap-action">üìã View Profile</button>
      </div>
    </div>
  `;
}

// ===== CHILDREN GAPS =====
function renderChildrenGaps(){
  if(!gaps.childrenGap.length){
    document.getElementById('tab-children').innerHTML = '<div class="empty-state"><div class="empty-icon">‚úì</div><div class="empty-text">No children discrepancies found</div></div>';
    return;
  }
  
  var html = '<div class="gap-grid">';
  gaps.childrenGap.forEach(function(item){
    var p = item.person;
    html += renderGapCard(p, 'Children count mismatch', 'medium', [
      {icon:'üìù', text:`Notes mention ${item.mentioned} children`, cls:'note'},
      {icon:'üìä', text:`Database has ${item.recorded} children`, cls:'partial'},
      {icon:'‚ö†Ô∏è', text:`${item.mentioned - item.recorded} children may be missing`, cls:'missing'}
    ]);
  });
  html += '</div>';
  document.getElementById('tab-children').innerHTML = html;
}

// ===== ONE PARENT GAPS =====
function renderOneParentGaps(){
  var html = '<div class="gap-grid">';
  
  gaps.missingMother.forEach(function(p){
    var father = peopleMap[p.fatherId];
    html += renderGapCard(p, 'Missing mother', 'medium', [
      {icon:'‚úì', text:`Father: ${pName(father)}`, cls:'note'},
      {icon:'‚ö†Ô∏è', text:'Mother not recorded', cls:'missing'}
    ]);
  });
  
  gaps.missingFather.forEach(function(p){
    var mother = peopleMap[p.motherId];
    html += renderGapCard(p, 'Missing father', 'medium', [
      {icon:'‚úì', text:`Mother: ${pName(mother)}`, cls:'note'},
      {icon:'‚ö†Ô∏è', text:'Father not recorded', cls:'missing'}
    ]);
  });
  
  html += '</div>';
  document.getElementById('tab-one-parent').innerHTML = html;
}

// ===== NO SPOUSE GAPS =====
function renderNoSpouseGaps(){
  if(!gaps.missingSpouse.length){
    document.getElementById('tab-no-spouse').innerHTML = '<div class="empty-state"><div class="empty-icon">‚úì</div><div class="empty-text">No missing spouse cases found</div></div>';
    return;
  }
  
  var html = '<div class="gap-grid">';
  gaps.missingSpouse.forEach(function(p){
    var childCount = p.childrenIds ? p.childrenIds.length : 0;
    html += renderGapCard(p, 'Missing spouse', 'high', [
      {icon:'‚ö†Ô∏è', text:`Has ${childCount} child${childCount!==1?'ren':''} but no spouse`, cls:'missing'},
      {icon:'‚ÑπÔ∏è', text:'Other parent may have died young or records lost', cls:'note'}
    ]);
  });
  html += '</div>';
  document.getElementById('tab-no-spouse').innerHTML = html;
}

// ===== ACCEPTED CHANGES =====
function renderAcceptedChanges(){
  if(!acceptedChanges.length){
    var html = '<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-text">No changes accepted yet. Research gaps and accept recommendations to build your changelist.</div></div>';
    document.getElementById('tab-accepted').innerHTML = html;
    return;
  }
  
  var html = `
    <div style="margin-bottom:1.5rem;display:flex;gap:0.8rem;align-items:center;">
      <h3 style="font-family:'Cormorant Garamond',serif;font-size:1.5rem;color:var(--accent);flex:1">${acceptedChanges.length} Change${acceptedChanges.length!==1?'s':''} Ready for Export</h3>
      <button class="gap-action primary" onclick="exportToExcel()">üì• Export to Excel</button>
      <button class="gap-action" onclick="exportChanges()">üíæ Export JSON</button>
    </div>
    <div class="gap-grid">
  `;
  
  acceptedChanges.forEach(function(ch, idx){
    var person = ch.data;
    var linkedTo = peopleMap[ch.personId] || {firstName:'?', lastName:''};
    html += `
      <div class="gap-card">
        <div class="gap-card-header">
          <div>
            <div class="gap-card-name">ADD: ${esc(person.firstName||'')} ${esc(person.lastName||'')}</div>
            <div class="gap-card-dates">${person.birthYear||'?'} - ${person.deathYear||'?'}</div>
          </div>
          <span class="gap-severity sev-low">${person.likelihood}%</span>
        </div>
        <div class="gap-card-body">
          <div class="gap-issues">
            <div class="gap-issue"><span class="gap-issue-icon note">üë§</span><span>${person.relationshipType} of ${esc(pName(linkedTo))}</span></div>
            <div class="gap-issue"><span class="gap-issue-icon note">üìç</span><span>${person.birthLocation||'Unknown location'}</span></div>
          </div>
        </div>
        <div class="gap-card-footer">
          <button class="gap-action" onclick="removeAccepted(${idx})">‚ùå Remove</button>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  html += '<div class="export-log" id="exportLog"></div>';
  document.getElementById('tab-accepted').innerHTML = html;
}

function removeAccepted(idx){
  acceptedChanges.splice(idx, 1);
  renderHeroStats();
  renderTabs();
  renderAcceptedChanges();
}

// ===== RESEARCH DRAWER =====
var currentResearchPerson = null;
var currentResearchIssue = null;

function researchPerson(personId, issue){
  currentResearchPerson = peopleMap[personId];
  currentResearchIssue = issue;
  
  if(!currentResearchPerson) return;
  
  document.getElementById('drawerTitle').textContent = 'AI Research: '+pName(currentResearchPerson);
  document.getElementById('drawerSubtitle').textContent = issue;
  
  document.getElementById('drawerBody').innerHTML = `
    <div class="drawer-loading">
      <div class="drawer-spinner"></div>
      <div class="drawer-loading-text">Analyzing family records...</div>
    </div>
  `;
  
  openDrawer();
  
  // Simulate AI research
  setTimeout(function(){
    generateSuggestions(currentResearchPerson, issue);
  }, 2000);
}

function generateSuggestions(person, issue){
  var suggestions = [];
  
  // Generate mock suggestions based on issue type
  if(issue.includes('mother')){
    suggestions.push({
      firstName: 'Mary',
      lastName: person.lastName || 'Unknown',
      gender: 'F',
      birthYear: person.birthYear ? person.birthYear - 25 : null,
      deathYear: null,
      birthLocation: person.birthCity || 'Unknown',
      relationshipType: 'mother',
      likelihood: 75,
      evidence: 'Common naming patterns and age estimates based on first child birth year',
      sources: ['Census records pattern', 'Age estimation']
    });
  }
  
  if(issue.includes('father')){
    suggestions.push({
      firstName: 'John',
      lastName: person.lastName || 'Unknown',
      gender: 'M',
      birthYear: person.birthYear ? person.birthYear - 28 : null,
      deathYear: null,
      birthLocation: person.birthCity || 'Unknown',
      relationshipType: 'father',
      likelihood: 70,
      evidence: 'Based on surname and typical father age at first child birth',
      sources: ['Naming conventions', 'Age patterns']
    });
  }
  
  if(issue.includes('spouse')){
    suggestions.push({
      firstName: person.gender==='M'?'Elizabeth':'William',
      lastName: person.gender==='M'?'Unknown':person.lastName,
      gender: person.gender==='M'?'F':'M',
      birthYear: person.birthYear,
      deathYear: null,
      birthLocation: person.birthCity || 'Unknown',
      relationshipType: 'spouse',
      likelihood: 65,
      evidence: 'Spouse likely existed as person has recorded children',
      sources: ['Family structure analysis']
    });
  }
  
  renderSuggestions(suggestions);
}

function renderSuggestions(suggestions){
  if(!suggestions.length){
    document.getElementById('drawerBody').innerHTML = '<div class="empty-state"><div class="empty-icon">üîç</div><div class="empty-text">No AI suggestions available for this gap</div></div>';
    return;
  }
  
  var html = '<div style="margin-bottom:1rem;padding:1rem;background:var(--accent-glow);border-radius:8px;font-size:0.85rem;color:var(--text-muted)">‚ö†Ô∏è These are AI-generated suggestions based on patterns. Always verify with historical records before adding to your database.</div>';
  
  suggestions.forEach(function(sugg, idx){
    var likelihoodCls = sugg.likelihood >= 75 ? 'likelihood-high' : sugg.likelihood >= 50 ? 'likelihood-medium' : 'likelihood-low';
    html += `
      <div class="drawer-result">
        <div class="drawer-result-header">
          <div class="drawer-result-title">${esc(sugg.firstName)} ${esc(sugg.lastName)}</div>
          <span class="likelihood-badge ${likelihoodCls}">${sugg.likelihood}% match</span>
        </div>
        <div class="drawer-result-details">
          <strong>Relationship:</strong> ${sugg.relationshipType}<br>
          <strong>Birth:</strong> ${sugg.birthYear||'Unknown'} in ${sugg.birthLocation}<br>
          <strong>Gender:</strong> ${sugg.gender}<br>
          <strong>Evidence:</strong> ${esc(sugg.evidence)}<br>
          <strong>Sources:</strong> ${sugg.sources.join(', ')}
        </div>
        <div class="drawer-result-actions">
          <button class="drawer-action-btn accept" onclick="acceptSuggestion(${idx})">‚úì Accept & Add to Changes</button>
          <button class="drawer-action-btn" onclick="closeDrawer()">Skip</button>
        </div>
      </div>
    `;
  });
  
  document.getElementById('drawerBody').innerHTML = html;
}

var currentSuggestions = [];
function acceptSuggestion(idx){
  var sugg = currentSuggestions[idx];
  if(!sugg) return;
  
  acceptedChanges.push({
    personId: currentResearchPerson.id,
    data: sugg,
    timestamp: new Date().toISOString()
  });
  
  renderHeroStats();
  renderTabs();
  closeDrawer();
  
  // Show success message
  alert('‚úì Suggestion added to accepted changes. Go to "Accepted Changes" tab to export.');
}

function openDrawer(){
  document.getElementById('researchDrawer').classList.add('open');
  document.getElementById('drawerBackdrop').classList.add('active');
}

function closeDrawer(){
  document.getElementById('researchDrawer').classList.remove('open');
  document.getElementById('drawerBackdrop').classList.remove('active');
}

// ===== EXPORT TO EXCEL =====
function exportToExcel(){
  if(!acceptedChanges.length) return;
  
  // Create HTML table that Excel can open
  var html = `
<html>
  <head>
    <meta charset="utf-8">
    <style>
      table { border-collapse: collapse; font-family: Arial, sans-serif; }
      th, td { border: 1px solid #d9cdb8; padding: 8px; text-align: left; }
      th { background-color: #8b6914; color: white; font-weight: bold; }
      tr:nth-child(even) { background-color: #faf7f2; }
    </style>
</head>
  <body>
    <h2>Owen Family - Approved Changes</h2>
    <p>Export Date: ${new Date().toLocaleString()}</p>
    <p>Total Changes: ${acceptedChanges.length}</p>
    <table>
      <tr>
        <th>Action</th>
        <th>First Name</th>
        <th>Last Name</th>
        <th>Gender</th>
        <th>Birth Year</th>
        <th>Death Year</th>
        <th>Birth Location</th>
        <th>Relationship To</th>
        <th>Relationship Type</th>
        <th>Confidence</th>
        <th>Evidence</th>
        <th>Sources</th>
      </tr>
  `;
  
  acceptedChanges.forEach(function(ch){
    var person = ch.data;
    var linkedTo = peopleMap[ch.personId] || {firstName:'?', lastName:''};
    html += `
      <tr>
        <td>ADD</td>
        <td>${person.firstName || ''}</td>
        <td>${person.lastName || ''}</td>
        <td>${person.gender || ''}</td>
        <td>${person.birthYear || ''}</td>
        <td>${person.deathYear || ''}</td>
        <td>${person.birthLocation || ''}</td>
        <td>${linkedTo.firstName} ${linkedTo.lastName}</td>
        <td>${person.relationshipType || ''}</td>
        <td>${person.likelihood}%</td>
        <td>${(person.evidence || '').replace(/"/g, '""')}</td>
        <td>${(person.sources || []).join('; ')}</td>
      </tr>
    `;
  });
  
  html += `
    </table>
  </body>
</html>
  `;
  
  var blob = new Blob([html], {type:'application/vnd.ms-excel'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'owen_family_changes_'+new Date().toISOString().slice(0,10)+'.xls';
  a.click();
  URL.revokeObjectURL(url);
  
  var log = document.getElementById('exportLog');
  if(log){
    log.classList.add('active');
    log.textContent = 'Exported '+acceptedChanges.length+' changes to Excel at '+new Date().toLocaleString();
  }
}

// ===== EXPORT =====
function exportChanges(){
  if(!acceptedChanges.length) return;
  var exportData = {
    exportDate: new Date().toISOString(),
    sourceDatabase: 'Owen_Geneology_Database_20260205v3.xlsx',
    totalChanges: acceptedChanges.length,
    changes: acceptedChanges.map(function(ch){
      return {
        action: 'add_person',
        newPerson: ch.data,
        linkTo: {
          personId: ch.personId,
          personName: pName(peopleMap[ch.personId]||{firstName:'?',lastName:''}),
          relationship: ch.data.relationshipType
        },
        confidence: ch.data.likelihood,
        evidence: ch.data.evidence,
        acceptedAt: ch.timestamp
      };
    })
  };

  var blob = new Blob([JSON.stringify(exportData, null, 2)], {type:'application/json'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'owen_family_changes_'+new Date().toISOString().slice(0,10)+'.json';
  a.click();
  URL.revokeObjectURL(url);

  var log = document.getElementById('exportLog');
  if(log){
    log.classList.add('active');
    log.textContent = 'Exported '+acceptedChanges.length+' changes at '+new Date().toLocaleString()+'\n'+JSON.stringify(exportData,null,2).substring(0,500)+'...';
  }
}

// ===== INIT =====
initValidation();

</script>
</body>
</html>
