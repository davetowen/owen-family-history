<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Owen Family Tree</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#f5f0e8;--bg-subtle:#ede7db;--text:#2c2418;--text-muted:#7a6e5e;--accent:#8b6914;--accent-light:#c4a44a;--card-bg:#fffdf7;--card-border:#d4c9b4;--card-shadow:rgba(44,36,24,.08);--male-bg:#eef3f8;--male-border:#b0c4d8;--female-bg:#f8eef3;--female-border:#d8b0c4;--spouse-line:#c4a44a;--child-line:#6e8a6e;--sibling-line:#9a8a7a;--gen-stripe:rgba(139,105,20,.05);--divider:rgba(139,105,20,.13)}
*{margin:0;padding:0;box-sizing:border-box}body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;display:flex;flex-direction:column}
.home-nav{background:var(--bg-subtle);padding:8px 16px;border-bottom:1px solid var(--card-border)}
.home-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:6px;color:var(--text);text-decoration:none;font-size:.8rem;font-weight:500;transition:all .2s}
.home-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent);transform:translateY(-1px)}
.header{text-align:center;padding:20px 24px 8px;background:linear-gradient(180deg,#faf6ee,var(--bg))}
.header h1{font-family:'Cormorant Garamond',serif;font-weight:700;font-size:1.8rem;color:var(--accent);letter-spacing:.02em}
.header p{font-size:.82rem;color:var(--text-muted);margin-top:4px;font-weight:300}
.controls{display:flex;justify-content:center;align-items:center;gap:18px;padding:10px 24px;background:var(--bg-subtle);border-bottom:1px solid var(--card-border);flex-wrap:wrap}
.cg{display:flex;align-items:center;gap:7px;font-size:.8rem;color:var(--text-muted)}
.cg label{font-weight:500;white-space:nowrap}
.cg select,.cg input[type=range]{font-family:'DM Sans',sans-serif;font-size:.78rem;padding:4px 8px;border:1px solid var(--card-border);border-radius:6px;background:var(--card-bg);color:var(--text);cursor:pointer}
.cg select{max-width:250px}.cg input[type=range]{width:100px;accent-color:var(--accent)}
.tl{display:flex;align-items:center;gap:5px;font-size:.8rem;color:var(--text-muted);cursor:pointer;user-select:none}
.ts{position:relative;width:34px;height:18px;background:var(--card-border);border-radius:9px;transition:background .2s;flex-shrink:0}
.ts::after{content:'';position:absolute;top:2px;left:2px;width:14px;height:14px;background:#fff;border-radius:50%;transition:transform .2s}
.ts.on{background:var(--accent)}.ts.on::after{transform:translateX(16px)}
.legend{display:flex;justify-content:center;gap:18px;padding:6px 24px;border-bottom:1px solid var(--card-border);flex-wrap:wrap;font-size:.7rem;color:var(--text-muted)}
.legend-item{display:flex;align-items:center;gap:4px}
.legend-sw{width:18px;height:2px;border-radius:2px}
.legend-cd{width:13px;height:10px;border-radius:2px;border:1.5px solid}
.tc{position:relative;overflow:auto;padding:30px 30px 30px 100px;flex:1}
.tv{position:relative;margin:0 auto}
.tv svg{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1}
.gl{position:absolute;left:-95px;font-family:'Cormorant Garamond',serif;font-weight:600;color:var(--accent-light);text-transform:uppercase;letter-spacing:.06em;white-space:nowrap;z-index:0;width:88px;text-align:right}
.gs{position:absolute;left:0;width:100%;pointer-events:none;z-index:0}
.pc{position:absolute;background:var(--card-bg);border:1.5px solid var(--card-border);border-radius:7px;cursor:pointer;z-index:2;transition:box-shadow .15s,transform .1s;display:flex;flex-direction:column;justify-content:center;box-shadow:0 1px 4px var(--card-shadow);overflow:hidden}
.pc:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(44,36,24,.14);z-index:10}
.pc.m{background:var(--male-bg);border-color:var(--male-border)}
.pc.f{background:var(--female-bg);border-color:var(--female-border)}
.pc.root{border-width:2.5px;border-color:var(--accent);box-shadow:0 2px 10px rgba(139,105,20,.18)}
.pc.sib{opacity:.72;border-style:dashed}
.cn{font-family:'Cormorant Garamond',serif;font-weight:700;line-height:1.12;color:var(--text)}
.cm{font-family:'Cormorant Garamond',serif;font-style:italic;color:var(--text-muted)}
.cd{color:var(--text-muted);font-weight:300}
.ci{color:var(--accent-light);font-weight:600;letter-spacing:.05em}
.dp{position:fixed;bottom:16px;right:16px;width:350px;max-height:72vh;background:var(--card-bg);border:1px solid var(--card-border);border-radius:10px;box-shadow:0 8px 32px rgba(44,36,24,.16);z-index:200;overflow:hidden;display:none;flex-direction:column}
.dp.vis{display:flex}
.dh{display:flex;justify-content:space-between;align-items:flex-start;padding:14px 16px 10px;border-bottom:1px solid var(--card-border);background:linear-gradient(180deg,#faf6ee,var(--card-bg))}
.dh h3{font-family:'Cormorant Garamond',serif;font-size:1.12rem;font-weight:700;color:var(--accent);line-height:1.2;flex:1}
.dh .st{font-size:.75rem;color:var(--text-muted);font-style:italic;margin-top:2px}
.cb{background:none;border:none;font-size:1.2rem;color:var(--text-muted);cursor:pointer;padding:0 4px;line-height:1;flex-shrink:0;margin-left:8px}.cb:hover{color:var(--text)}
.db{padding:12px 16px 16px;overflow-y:auto;font-size:.78rem;line-height:1.55;color:var(--text)}
.ds{margin-bottom:11px}.ds:last-child{margin-bottom:0}
.dst{font-weight:600;font-size:.7rem;text-transform:uppercase;letter-spacing:.08em;color:var(--accent);margin-bottom:3px;border-bottom:1px solid var(--gen-stripe);padding-bottom:2px}
.dr{display:flex;gap:6px;padding:1px 0}.dl{font-weight:500;color:var(--text-muted);min-width:82px;flex-shrink:0}.dv{color:var(--text)}
.osb{display:inline-block;background:#f0ead8;border:1px solid var(--card-border);border-radius:4px;padding:1px 6px;font-size:.7rem;color:var(--accent);margin-top:2px}
.sb{text-align:center;padding:5px;font-size:.7rem;color:var(--text-muted);border-top:1px solid var(--card-border);background:var(--bg-subtle)}
.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;transition:opacity .4s}
.loading-overlay.hidden{opacity:0;pointer-events:none}
.loading-spinner{width:40px;height:40px;border:3px solid var(--card-border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{margin-top:16px;font-family:'Cormorant Garamond',serif;font-size:1.1rem;color:var(--accent);font-weight:600}
.loading-sub{margin-top:4px;font-size:.78rem;color:var(--text-muted)}
.load-error{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;text-align:center;padding:24px}
.load-error h2{font-family:'Cormorant Garamond',serif;color:var(--accent);margin-bottom:8px}
.load-error p{color:var(--text-muted);max-width:420px;font-size:.85rem;line-height:1.5}
.load-error button{margin-top:16px;padding:8px 20px;background:var(--accent);color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:.85rem;font-weight:500}
.load-error button:hover{background:#a07b18}
</style>
<script src="data-loader.js"></script>
</head>
<body>
<div class="home-nav"><a href="index.html" class="home-btn">← Return to Home</a></div>
<div class="header"><h1>The Owen Family</h1><p id="sub">Select any family member from the Focus dropdown to explore their ancestry</p></div>
<div class="controls">
  <div class="cg"><label for="fs">Focus:</label><select id="fs"></select></div>
  <div class="cg"><label for="gs">Generations:</label><input type="range" id="gs" min="2" max="24" value="4"><span id="gc">4</span></div>
  <div class="cg"><label class="tl" id="st"><div class="ts" id="ss"></div>Siblings</label></div>
  <div class="cg"><label class="tl" id="ft"><div class="ts" id="fts"></div>Fit to window</label></div>
</div>
<div class="legend">
  <div class="legend-item"><div class="legend-cd" style="background:var(--male-bg);border-color:var(--male-border)"></div>Male</div>
  <div class="legend-item"><div class="legend-cd" style="background:var(--female-bg);border-color:var(--female-border)"></div>Female</div>
  <div class="legend-item"><div class="legend-sw" style="background:var(--spouse-line)"></div>Spouse</div>
  <div class="legend-item"><div class="legend-sw" style="background:var(--child-line)"></div>Parent→Child</div>
  <div class="legend-item"><div class="legend-cd" style="background:var(--card-bg);border-color:var(--accent);border-width:2.5px"></div>Focus</div>
  <div class="legend-item"><div class="legend-cd" style="background:var(--card-bg);border-color:var(--card-border);border-style:dashed;opacity:.65"></div>Sibling</div>
</div>
<div class="tc"><div class="tv" id="tv"><svg id="svg"></svg></div></div>
<div class="sb" id="sb"></div>
<div class="dp" id="dp">
  <div class="dh"><div><h3 id="dn"></h3><div class="st" id="ds"></div></div><button class="cb" id="dc">✕</button></div>
  <div class="db" id="dbd"></div>
</div>
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text">Loading Owen Family Data</div>
  <div class="loading-sub">Fetching from Google Sheets…</div>
</div>
<script>
let AP={},FL=[];
let S={fid:'P001',mg:4,sib:false,fit:false},CTM={};
const B_CW=168,B_CH=80,B_SG=26,B_GG=115,B_MPAD=20;
let CW,CH,SG,GG,MPAD,SCALE=1;

function initC(){
  const s=document.getElementById('fs');
  for(const i of FL){const o=document.createElement('option');o.value=i.id;
    o.textContent=`${i.name}${i.birthYear?' (b. '+i.birthYear+')':''} — ${i.id}`;
    if(i.id===S.fid)o.selected=true;s.appendChild(o);}
  s.addEventListener('change',()=>{S.fid=s.value;rebuild();});
  const sl=document.getElementById('gs'),gc=document.getElementById('gc');
  sl.value=S.mg;gc.textContent=S.mg;
  sl.addEventListener('input',()=>{S.mg=+sl.value;gc.textContent=S.mg;rebuild();});
  document.getElementById('st').addEventListener('click',()=>{
    S.sib=!S.sib;document.getElementById('ss').classList.toggle('on',S.sib);rebuild();});
  document.getElementById('ft').addEventListener('click',()=>{
    S.fit=!S.fit;document.getElementById('fts').classList.toggle('on',S.fit);rebuild();});
  document.getElementById('dc').addEventListener('click',()=>document.getElementById('dp').classList.remove('vis'));
  document.addEventListener('click',e=>{const p=document.getElementById('dp');
    if(p.classList.contains('vis')&&!p.contains(e.target)&&!e.target.closest('.pc'))p.classList.remove('vis');});
}

function getAnc(fid,mg){
  const v={},q=[[fid,0,'']];
  while(q.length){const[pid,g,pa]=q.shift();if(!AP[pid]||pid in v||g>=mg)continue;
    v[pid]={g,pa};const p=AP[pid];
    if(p.fatherId&&AP[p.fatherId])q.push([p.fatherId,g+1,pa+'0']);
    if(p.motherId&&AP[p.motherId])q.push([p.motherId,g+1,pa+'1']);}
  return v;
}
function htc(a,b,tm){
  const p1=AP[a],p2=AP[b],ks=new Set([...(p1.childrenIds||[]),...(p2.childrenIds||[])]);
  const h=p1.gender==='M'?a:b,w=p1.gender==='M'?b:a;
  for(const c of ks){const ch=AP[c];if(ch&&c in tm&&ch.fatherId===h&&ch.motherId===w)return true;}return false;
}
function addSp(ai){
  const e={};for(const[p,i]of Object.entries(ai))e[p]={...i};
  for(const[pid,info]of Object.entries(ai)){const p=AP[pid];
    for(const sid of(p.spouseIds||[])){if(!AP[sid]||sid in e)continue;
      if(htc(pid,sid,ai)){const sp=info.pa.length>0?info.pa.slice(0,-1)+(info.pa.endsWith('0')?'1':'0'):'1';
        e[sid]={g:info.g,pa:sp};}}}return e;
}
function buildC(ti){
  const cs=[],seen=new Set();
  for(const pid of Object.keys(ti)){const p=AP[pid];
    for(const sid of(p.spouseIds||[])){if(!(sid in ti))continue;
      const h=p.gender==='M'?pid:sid,w=p.gender==='M'?sid:pid,k=h+'|'+w;
      if(seen.has(k))continue;seen.add(k);
      const hp=AP[h],wp=AP[w],ak=new Set([...(hp.childrenIds||[]),...(wp.childrenIds||[])]);
      const tc=[],sc=[];for(const c of ak){const ch=AP[c];if(!ch||ch.fatherId!==h||ch.motherId!==w)continue;
        if(c in ti)tc.push(c);else sc.push(c);}
      if(tc.length>0||h===S.fid||w===S.fid){
        const hP=ti[h].pa,wP=ti[w].pa;
        cs.push({h,w,g:ti[h].g,tc:tc.sort(),sc:sc.sort(),sp:hP.length<=wP.length?hP:wP});}}}
  return cs.sort((a,b)=>a.g-b.g||(a.sp<b.sp?-1:a.sp>b.sp?1:0));
}
function otherSp(pid){const p=AP[pid];return(p.spouseIds||[]).filter(s=>!(s in CTM)&&AP[s]);}

// ═══════════════════════════════════════════
// UNIFIED BSP LAYOUT
// ═══════════════════════════════════════════

function doLayout(ti,couples,showSib){
  const pos={},dividers=[],edges=[];
  const coupleOf={};for(const c of couples){coupleOf[c.h]=c;coupleOf[c.w]=c;}
  let maxG=0;for(const info of Object.values(ti))maxG=Math.max(maxG,info.g);

  function parentCouple(pid){
    const p=AP[pid];if(!p||!p.fatherId||!p.motherId)return null;
    return couples.find(c=>c.h===p.fatherId&&c.w===p.motherId)||null;
  }
  function loneParent(pid){
    const p=AP[pid];if(!p)return null;
    if(parentCouple(pid))return null;
    if(p.fatherId&&p.fatherId in ti)return p.fatherId;
    if(p.motherId&&p.motherId in ti)return p.motherId;
    return null;
  }

  // Width of ancestry above a person (recursive)
  const wC={};
  function ancW(pid){
    if(!pid||!(pid in ti))return CW+MPAD;
    if(wC[pid]!==undefined)return wC[pid];
    const pc=parentCouple(pid);
    if(pc){
      const lw=Math.max(CW+MPAD,ancW(pc.h));
      const rw=Math.max(CW+MPAD,ancW(pc.w));
      let w=lw+SG+rw;
      if(showSib&&pc.sc.length>0){
        const sibW=pc.sc.length*(CW+8*SCALE);
        const slack=w-CW*2-SG;
        if(sibW>slack)w+=sibW-slack;
      }
      wC[pid]=w;return w;
    }
    const lp=loneParent(pid);
    if(lp){const w=Math.max(CW+MPAD,ancW(lp));wC[pid]=w;return w;}
    wC[pid]=CW+MPAD;return CW+MPAD;
  }

  // Position ancestry ABOVE an already-positioned person
  function posAnc(pid,regionL,regionR){
    const pc=parentCouple(pid);
    if(pc){
      const lw=Math.max(CW+MPAD,ancW(pc.h));
      const rw=Math.max(CW+MPAD,ancW(pc.w));
      const totalW=lw+SG+rw;
      const regionW=regionR-regionL;
      const offset=Math.max(0,(regionW-totalW)/2);
      const coupleL=regionL+offset;
      const centerX=coupleL+lw;
      const yP=pos[pid].y-(CH+GG);

      pos[pc.h]={x:centerX-SG/2-CW,y:yP};
      pos[pc.w]={x:centerX+SG/2,y:yP};
      dividers.push({x:centerX,y1:yP-GG*0.4,y2:yP+CH+GG*0.35});
      edges.push({type:'couple-child',couple:pc,childId:pid});

      // Siblings below the couple
      if(showSib&&pc.sc.length>0){
        const sibY=yP+CH+38*SCALE;
        let sx=centerX-SG/2-CW-12*SCALE;
        for(let i=pc.sc.length-1;i>=0;i--){
          sx-=CW;pos[pc.sc[i]]={x:sx,y:sibY,isSibling:true};sx-=8*SCALE;
        }
      }

      // Recurse upward for H and W
      posAnc(pc.h,coupleL,centerX);
      posAnc(pc.w,centerX,coupleL+totalW);
      return;
    }
    const lp=loneParent(pid);
    if(lp&&!(lp in pos)){
      const cx=(regionL+regionR)/2;
      const yP=pos[pid].y-(CH+GG);
      pos[lp]={x:cx-CW/2,y:yP};
      edges.push({type:'lone-parent',parentId:lp,childId:pid});
      posAnc(lp,regionL,regionR);
    }
  }

  // Entry: find the bottom couple (focus person's couple or parent couple)
  const focusP=AP[S.fid];
  const focusCouple=coupleOf[S.fid]||null;
  let bc=focusCouple;
  if(!bc&&focusP&&focusP.fatherId&&focusP.motherId){
    bc=couples.find(c=>c.h===focusP.fatherId&&c.w===focusP.motherId)||null;
  }

  if(bc){
    const lw=Math.max(CW+MPAD,ancW(bc.h));
    const rw=Math.max(CW+MPAD,ancW(bc.w));
    const totalW=lw+SG+rw;
    const centerX=50+lw;
    const yBottom=40+maxG*(CH+GG);

    // If focus is in the couple, couple is at the bottom row
    // If focus is a child of the couple, couple is one row up
    const isMember=(S.fid===bc.h||S.fid===bc.w);
    const coupleY=isMember?yBottom:yBottom-(CH+GG);

    pos[bc.h]={x:centerX-SG/2-CW,y:coupleY};
    pos[bc.w]={x:centerX+SG/2,y:coupleY};
    dividers.push({x:centerX,y1:coupleY-GG*0.4,y2:coupleY+CH+GG*0.35});

    // Position focus person if they're a child
    if(!isMember){
      const pcx=(pos[bc.h].x+pos[bc.w].x+CW)/2;
      pos[S.fid]={x:pcx-CW/2,y:yBottom};
      edges.push({type:'couple-child',couple:bc,childId:S.fid});
    }

    // Siblings of the bottom couple
    if(showSib&&bc.sc.length>0){
      const sibY=coupleY+CH+38*SCALE;
      let sx=centerX-SG/2-CW-12*SCALE;
      for(let i=bc.sc.length-1;i>=0;i--){
        sx-=CW;pos[bc.sc[i]]={x:sx,y:sibY,isSibling:true};sx-=8*SCALE;
      }
    }

    // Position ancestry upward from H and W
    posAnc(bc.h,50,centerX);
    posAnc(bc.w,centerX,50+totalW);
  } else {
    // Solo focus person
    const yBottom=40+maxG*(CH+GG);
    pos[S.fid]={x:50,y:yBottom};
    const lp=loneParent(S.fid);
    if(lp){
      const w=Math.max(CW+MPAD,ancW(lp));
      pos[lp]={x:50+w/2-CW/2,y:yBottom-(CH+GG)};
      edges.push({type:'lone-parent',parentId:lp,childId:S.fid});
      posAnc(lp,50,50+w);
    }
  }

  // Fallback for any unpositioned
  for(const pid of Object.keys(ti)){
    if(!(pid in pos))pos[pid]={x:50,y:40+(maxG-ti[pid].g)*(CH+GG)};
  }

  return normalize(pos,dividers,edges);
}

function normalize(pos,dividers,edges){
  let mnX=1e9,mnY=1e9,mxX=-1e9,mxY=-1e9;
  for(const p of Object.values(pos)){mnX=Math.min(mnX,p.x);mnY=Math.min(mnY,p.y);mxX=Math.max(mxX,p.x+CW);mxY=Math.max(mxY,p.y+CH);}
  if(mnX===1e9){mnX=0;mnY=0;mxX=CW;mxY=CH;}
  const sx=50-mnX,sy=40-mnY;
  for(const p of Object.values(pos)){p.x+=sx;p.y+=sy;}
  for(const d of dividers){d.x+=sx;d.y1+=sy;d.y2+=sy;}
  return{pos,totalW:mxX-mnX+140,totalH:mxY-mnY+120,dividers,edges};
}

// ═══════════════════════════════════════════
// RENDERING
// ═══════════════════════════════════════════
function renderAll(pos,ti,couples,dividers,edges,showSib){
  const vp=document.getElementById('tv');
  vp.querySelectorAll('.pc,.gl,.gs').forEach(e=>e.remove());
  const svg=document.getElementById('svg');svg.innerHTML='';
  const fs=Math.max(0.45,SCALE);

  // Dividers
  for(const d of dividers){
    const l=document.createElementNS('http://www.w3.org/2000/svg','line');
    l.setAttribute('x1',d.x);l.setAttribute('y1',d.y1);l.setAttribute('x2',d.x);l.setAttribute('y2',d.y2);
    l.setAttribute('stroke','var(--divider)');l.setAttribute('stroke-width',Math.max(0.5,SCALE));
    l.setAttribute('stroke-dasharray',`${6*SCALE},${4*SCALE}`);svg.appendChild(l);
  }

  // Gen labels
  const genYs={};
  for(const[pid,p]of Object.entries(pos)){if(p.isSibling)continue;const g=ti[pid]?.g;
    if(g!==undefined&&(!(g in genYs)||p.y<genYs[g]))genYs[g]=p.y;}
  const gn=['Focus','Parents','Grandparents','Gt-GP','2×Gt-GP','3×Gt-GP','4×Gt-GP','5×Gt-GP',
    '6×Gt-GP','7×Gt-GP','8×Gt-GP','9×Gt-GP','10×Gt-GP','11×Gt-GP','12×Gt-GP','13×Gt-GP',
    '14×Gt-GP','15×Gt-GP','16×Gt-GP','17×Gt-GP','18×Gt-GP','19×Gt-GP','20×Gt-GP','21×Gt-GP'];
  for(const[g,y]of Object.entries(genYs)){const gi=parseInt(g);
    const l=document.createElement('div');l.className='gl';l.style.top=`${y+CH/2-8*SCALE}px`;
    l.style.fontSize=`${Math.max(0.45,0.68*SCALE)}rem`;l.textContent=gn[gi]||`Gen ${gi}`;vp.appendChild(l);
    const s=document.createElement('div');s.className='gs';s.style.top=`${y-6*SCALE}px`;
    s.style.height=`${CH+12*SCALE}px`;s.style.background=gi%2===0?'var(--gen-stripe)':'transparent';vp.appendChild(s);
  }

  // Cards
  for(const[pid,p]of Object.entries(pos)){
    const pr=AP[pid];if(!pr)continue;const isSib=p.isSibling||false;
    const c=document.createElement('div');
    c.className=`pc ${pr.gender==='M'?'m':'f'} ${pid===S.fid?'root':''} ${isSib?'sib':''}`;
    c.style.left=`${p.x}px`;c.style.top=`${p.y}px`;c.style.width=`${CW}px`;c.style.height=`${CH}px`;
    c.style.padding=`${6*SCALE}px ${8*SCALE}px`;c.style.borderRadius=`${7*SCALE}px`;
    const dn=`${pr.firstName} ${pr.lastName}`,md=pr.maidenName?`née ${pr.maidenName}`:'';
    const dt=pr.deathYear?`${pr.birthYear||'?'}–${pr.deathYear}`:pr.birthYear?`b. ${pr.birthYear}`:'';
    c.innerHTML=`<div class="cn" style="font-size:${Math.max(.45,.88*fs)}rem">${dn}</div>${md?`<div class="cm" style="font-size:${Math.max(.38,.72*fs)}rem">${md}</div>`:''}<div class="cd" style="font-size:${Math.max(.35,.67*fs)}rem">${dt}</div><div class="ci" style="font-size:${Math.max(.32,.57*fs)}rem">${pid}</div>`;
    c.addEventListener('click',e=>{e.stopPropagation();showDetail(pid);});vp.appendChild(c);
  }

  // Connectors: spouse lines + couple-to-child
  const drawnSpouse=new Set();
  for(const c of couples){
    const hP=pos[c.h],wP=pos[c.w];if(!hP||!wP)continue;
    const k=c.h+'|'+c.w;if(drawnSpouse.has(k))continue;drawnSpouse.add(k);
    const hrx=hP.x+CW,hry=hP.y+CH/2,wlx=wP.x,wly=wP.y+CH/2;
    mkP(`M${hrx} ${hry}L${wlx} ${wly}`,'var(--spouse-line)',Math.max(1,2.5*SCALE));
    mkD((hrx+wlx)/2,hry,'#c4a44a');
    // Draw to tree children
    const ccx=(hrx+wlx)/2,ccy=hry;
    const kids=[...c.tc];if(showSib)kids.push(...c.sc);
    if(!kids.length)continue;
    const pts=[];for(const cid of kids){const cp=pos[cid];if(!cp)continue;
      pts.push({x:cp.x+CW/2,y:cp.y,s:c.sc.includes(cid)});}
    if(!pts.length)continue;
    const pBot=hP.y+CH,minCY=Math.min(...pts.map(p=>p.y));
    if(minCY<=pBot)continue; // skip if child is above parent (shouldn't happen)
    const rY=pBot+(minCY-pBot)*0.45;
    mkP(`M${ccx} ${ccy}L${ccx} ${rY}`,'var(--child-line)',Math.max(1,2*SCALE));
    const allX=[ccx,...pts.map(p=>p.x)];
    mkP(`M${Math.min(...allX)} ${rY}L${Math.max(...allX)} ${rY}`,'var(--child-line)',Math.max(1,2*SCALE));
    for(const pt of pts){
      const lc=pt.s?'var(--sibling-line)':'var(--child-line)';
      const da=pt.s?`${4*SCALE},${3*SCALE}`:null;
      mkP(`M${pt.x} ${rY}L${pt.x} ${pt.y}`,lc,pt.s?Math.max(.8,1.5*SCALE):Math.max(1,2*SCALE),da);
      mkA(pt.x,pt.y,pt.s?'#9a8a7a':'#6e8a6e');
    }
  }

  // Draw lone parent -> child connections
  for(const e of edges){
    if(e.type==='lone-parent'){
      const pp=pos[e.parentId],cp=pos[e.childId];
      if(!pp||!cp)continue;
      if(cp.y<=pp.y)continue;
      const px=pp.x+CW/2,py=pp.y+CH,cx=cp.x+CW/2,cy=cp.y;
      const rY=py+(cy-py)*0.45;
      mkP(`M${px} ${py}L${px} ${rY}L${cx} ${rY}L${cx} ${cy}`,'var(--child-line)',Math.max(1,2*SCALE));
      mkA(cx,cy,'#6e8a6e');
    }
  }

  function mkP(d,col,w,dash){const p=document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('d',d);p.setAttribute('fill','none');p.setAttribute('stroke',col);
    p.setAttribute('stroke-width',w||2);p.setAttribute('stroke-linecap','round');p.setAttribute('stroke-linejoin','round');
    if(dash)p.setAttribute('stroke-dasharray',dash);svg.appendChild(p);}
  function mkA(x,y,col){const sz=Math.max(2,4*SCALE);const a=document.createElementNS('http://www.w3.org/2000/svg','polygon');
    a.setAttribute('points',`${x},${y} ${x-sz},${y-sz*1.5} ${x+sz},${y-sz*1.5}`);a.setAttribute('fill',col);svg.appendChild(a);}
  function mkD(x,y,col){const sz=Math.max(2,4*SCALE);const d=document.createElementNS('http://www.w3.org/2000/svg','polygon');
    d.setAttribute('points',`${x},${y-sz} ${x+sz},${y} ${x},${y+sz} ${x-sz},${y}`);d.setAttribute('fill',col);svg.appendChild(d);}
}

// ── DETAIL ──
function showDetail(pid){
  const p=AP[pid];if(!p)return;
  document.getElementById('dn').textContent=`${p.firstName} ${p.lastName}${p.maidenName?' (née '+p.maidenName+')':''}`;
  document.getElementById('ds').textContent=`${pid} · ${p.gender==='M'?'Male':'Female'}`;
  const ss=[];let v='';
  if(p.birthYear){const bp=[p.birthCity,p.birthState,p.birthCountry].filter(Boolean).join(', ');v+=R('Born',`${p.birthYear}${bp?' · '+bp:''}`);}
  if(p.deathYear){const dp=[p.deathCity,p.deathState,p.deathCountry].filter(Boolean).join(', ');v+=R('Died',`${p.deathYear}${dp?' · '+dp:''}${p.ageAtDeath&&p.ageAtDeath!=='Alive'?' (age '+p.ageAtDeath+')':''}`);}
  else if(p.birthYear)v+=R('Status','Living');
  if(p.burialPlace)v+=R('Burial',p.burialPlace);if(v)ss.push(Sc('Vital Records',v));
  let f='';
  if(p.fatherId&&AP[p.fatherId]){const fa=AP[p.fatherId];f+=R('Father',`${fa.firstName} ${fa.lastName} (${p.fatherId})`);}
  if(p.motherId&&AP[p.motherId]){const mo=AP[p.motherId];f+=R('Mother',`${mo.firstName} ${mo.maidenName||mo.lastName} (${p.motherId})`);}
  if(p.spouseIds&&p.spouseIds.length>0){const os=otherSp(pid);f+=R('Spouse(s)',p.spouseIds.map(sid=>{const s=AP[sid];if(!s)return sid;
    const nm=`${s.firstName} ${s.lastName} (${sid})`;return os.includes(sid)?nm+' <span class="osb">not in tree</span>':nm;}).join('<br>'));}
  if(p.childrenIds&&p.childrenIds.length>0)f+=R('Children',p.childrenIds.map(c=>{const ch=AP[c];return ch?`${ch.firstName} ${ch.lastName} (${c})`:c;}).join('<br>'));
  if(p.siblingIds&&p.siblingIds.length>0)f+=R('Siblings',p.siblingIds.map(s=>{const si=AP[s];return si?`${si.firstName} ${si.lastName} (${s})`:s;}).join('<br>'));
  if(f)ss.push(Sc('Family',f));
  let ca='';if(p.occupation)ca+=R('Occupation',p.occupation);if(p.employers)ca+=R('Employers',p.employers);if(ca)ss.push(Sc('Career',ca));
  let m='';if(p.military)m+=R('Service',p.military);if(p.militaryBranch)m+=R('Branch',p.militaryBranch);if(p.war)m+=R('War',p.war);
  if(p.servedFrom||p.servedTo)m+=R('Period',`${p.servedFrom||'?'} – ${p.servedTo||'?'}`);if(m)ss.push(Sc('Military Service',m));
  let e='';if(p.undergradUniv)e+=R('Undergrad',`${p.undergradUniv}${p.undergradYear?' ('+p.undergradYear+')':''}`);
  if(p.gradUniv)e+=R('Graduate',`${p.gradUniv}${p.gradYear?' ('+p.gradYear+')':''}`);
  if(p.fraternity)e+=R('Greek Life',p.fraternity);if(p.sports)e+=R('Sports',p.sports);if(e)ss.push(Sc('Education',e));
  let o='';if(p.branchLineage)o+=R('Lineage',p.branchLineage);if(p.immigrationYear)o+=R('Immigrated',p.immigrationYear);
  if(p.generationAmerican)o+=R('Gen. American',p.generationAmerican);if(p.confidence)o+=R('Confidence',p.confidence);if(o)ss.push(Sc('Other Details',o));
  if(p.notes)ss.push(Sc('Notes & Stories','<div style="white-space:pre-wrap">'+p.notes+'</div>'));
  document.getElementById('dbd').innerHTML=ss.join('')||'<em style="color:var(--text-muted)">No additional details.</em>';
  document.getElementById('dp').classList.add('vis');
}
function Sc(t,c){return'<div class="ds"><div class="dst">'+t+'</div>'+c+'</div>';}
function R(l,v){return'<div class="dr"><span class="dl">'+l+':</span><span class="dv">'+v+'</span></div>';}

function rebuild(){
  const ai=getAnc(S.fid,S.mg);const ti=addSp(ai);const cs=buildC(ti);
  CTM={};for(const[pid,info]of Object.entries(ti))CTM[pid]=info;
  if(S.sib)for(const c of cs)for(const sid of c.sc)if(!(sid in ti))ti[sid]={g:c.g,pa:c.sp+'s'};

  SCALE=1;CW=B_CW;CH=B_CH;SG=B_SG;GG=B_GG;MPAD=B_MPAD;
  let{pos,totalW,totalH,dividers,edges}=doLayout(ti,cs,S.sib);

  if(S.fit){
    const ct=document.querySelector('.tc');
    const vpW=(ct?ct.clientWidth:window.innerWidth)-160;
    const vpH=(ct?ct.clientHeight:window.innerHeight)-220;
    const scX=vpW/totalW,scY=vpH/totalH;
    SCALE=Math.min(scX,scY,1);SCALE=Math.max(SCALE,0.15);
    CW=B_CW*SCALE;CH=B_CH*SCALE;SG=B_SG*SCALE;GG=B_GG*SCALE;MPAD=B_MPAD*SCALE;
    const r2=doLayout(ti,cs,S.sib);
    pos=r2.pos;totalW=r2.totalW;totalH=r2.totalH;dividers=r2.dividers;edges=r2.edges;
  }

  const vp=document.getElementById('tv');vp.style.width=totalW+'px';vp.style.height=totalH+'px';
  const svg=document.getElementById('svg');svg.setAttribute('width',totalW);svg.setAttribute('height',totalH);
  svg.setAttribute('viewBox','0 0 '+totalW+' '+totalH);
  renderAll(pos,ti,cs,dividers,edges,S.sib);
  const fp=AP[S.fid],pc=Object.keys(pos).length;
  document.getElementById('sub').textContent='Ancestry of '+fp.firstName+' '+fp.lastName+' · '+S.mg+' Generations · '+pc+' People'+(S.fit?' · '+Math.round(SCALE*100)+'%':'');
  document.getElementById('sb').textContent=pc+' people · '+cs.length+' couples · '+S.mg+' generations'+(S.fit?' · Fit to window ('+Math.round(SCALE*100)+'%)':'');
}
document.addEventListener('DOMContentLoaded', async () => {
  // CSV URL defined in data-loader.js
  const overlay = document.getElementById('loadingOverlay');

  try {
    const db = owenFamilyDB; // Use global instance from data-loader.js
    const data = await db.getData();

    if (!data.people || data.people.length === 0) {
      throw new Error('No records returned from database');
    }

    // Build AP lookup (person ID → person object)
    AP = FamilyDatabase.buildLookup(data.people);

    // Build FL sorted list (by birth year, nulls at end, then alphabetical)
    FL = data.people
      .map(p => ({ id: p.id, name: p.name || p.fullName || (p.firstName + ' ' + p.lastName).trim(), birthYear: p.birthYear }))
      .sort((a, b) => {
        if (a.birthYear && b.birthYear) return a.birthYear - b.birthYear;
        if (a.birthYear) return -1;
        if (b.birthYear) return 1;
        return (a.name || '').localeCompare(b.name || '');
      });

    console.log('Family tree loaded: ' + data.people.length + ' people');

    // Validate focus person exists; fall back to first available
    if (!AP[S.fid] && FL.length > 0) {
      S.fid = FL[0].id;
      console.warn('Default focus person P001 not found, using ' + S.fid);
    }

    // Hide loading overlay
    overlay.classList.add('hidden');
    setTimeout(() => overlay.remove(), 500);

    // Initialize controls and render
    initC();
    rebuild();

  } catch (err) {
    console.error('Failed to load family data:', err);
    overlay.innerHTML =
      '<div class="load-error">' +
        '<h2>Unable to Load Family Data</h2>' +
        '<p>Could not connect to the Google Sheets database. ' +
        'Please check your internet connection and try again.</p>' +
        '<p style="margin-top:8px;font-size:.75rem;color:var(--text-muted)">' + err.message + '</p>' +
        '<button onclick="location.reload()">Retry</button>' +
      '</div>';
  }
});

</script>
</body>
</html>
