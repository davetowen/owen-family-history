<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Owen Family ‚Äî Person Research</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,500&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f0e8;
  --bg-card: #faf7f2;
  --bg-dark: #eee8db;
  --accent: #8b6914;
  --accent-light: #c4a44a;
  --accent-glow: rgba(139,105,20,0.12);
  --text: #2c2418;
  --text-muted: #6b5d4d;
  --text-light: #9a8b78;
  --border: #d9cdb8;
  --border-light: #e8dece;
  --success: #4a7c59;
  --danger: #8b3a3a;
  --info: #3a5f8b;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html { scroll-behavior: smooth; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  line-height: 1.6;
}

/* ===== HOME NAV ===== */
.home-nav {
  background: var(--bg-card);
  padding: 8px 16px;
  border-bottom: 1px solid var(--border);
}
.home-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  text-decoration: none;
  font-size: 0.8rem;
  font-weight: 500;
  transition: all .2s;
}
.home-btn:hover {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
  transform: translateY(-1px);
}

/* ===== HEADER ===== */
.site-header {
  background: linear-gradient(135deg, #2c2418 0%, #3d3224 50%, #2c2418 100%);
  padding: 2rem 2rem 1.8rem;
  position: relative;
  overflow: hidden;
}
.site-header::before {
  content: '';
  position: absolute;
  inset: 0;
  background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
}
.header-content {
  max-width: 1200px;
  margin: 0 auto;
  position: relative;
  z-index: 1;
}
.site-title {
  font-family: 'Cormorant Garamond', serif;
  font-weight: 300;
  font-size: 2.4rem;
  color: #f5f0e8;
  letter-spacing: 0.02em;
}
.site-title span {
  color: var(--accent-light);
  font-weight: 600;
}
.site-subtitle {
  color: #9a8b78;
  font-size: 0.95rem;
  margin-top: 0.3rem;
  font-weight: 300;
}

/* ===== MAIN LAYOUT ===== */
.main-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
}

/* ===== SEARCH SECTION ===== */
.search-section {
  margin-bottom: 2rem;
}
.search-box-wrapper {
  position: relative;
  max-width: 600px;
}
.search-input {
  width: 100%;
  padding: 1rem 1.2rem 1rem 3rem;
  font-family: 'DM Sans', sans-serif;
  font-size: 1.05rem;
  background: var(--bg-card);
  border: 2px solid var(--border);
  border-radius: 12px;
  color: var(--text);
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.search-input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 4px var(--accent-glow);
}
.search-input::placeholder { color: var(--text-light); }
.search-icon {
  position: absolute;
  left: 1rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-light);
  pointer-events: none;
}
.search-results-dropdown {
  position: absolute;
  top: calc(100% + 4px);
  left: 0;
  right: 0;
  background: var(--bg-card);
  border: 2px solid var(--border);
  border-radius: 12px;
  max-height: 400px;
  overflow-y: auto;
  z-index: 100;
  box-shadow: 0 12px 40px rgba(44,36,24,0.15);
  display: none;
}
.search-results-dropdown.active { display: block; }
.search-result-item {
  padding: 0.8rem 1.2rem;
  cursor: pointer;
  border-bottom: 1px solid var(--border-light);
  transition: background 0.15s;
}
.search-result-item:last-child { border-bottom: none; }
.search-result-item:hover { background: var(--accent-glow); }
.search-result-item .name {
  font-weight: 500;
  color: var(--text);
}
.search-result-item .meta {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-top: 0.15rem;
}
.search-result-item .branch-tag {
  display: inline-block;
  padding: 0.1rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 500;
  margin-left: 0.5rem;
}

/* ===== QUICK PICKS ===== */
.quick-picks {
  margin-top: 1.5rem;
}
.quick-picks-label {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-bottom: 0.8rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.quick-picks-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 0.8rem;
}
.quick-pick-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 0.8rem 1rem;
  cursor: pointer;
  transition: all 0.2s;
}
.quick-pick-card:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(139,105,20,0.1);
}
.quick-pick-name {
  font-weight: 500;
  color: var(--text);
  font-size: 0.95rem;
}
.quick-pick-dates {
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-top: 0.2rem;
}

/* ===== PROFILE CARD ===== */
.profile-section {
  display: none;
}
.profile-section.active { display: block; }

.profile-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(44,36,24,0.08);
}
.profile-header {
  padding: 2rem 2rem 1.5rem;
  background: linear-gradient(135deg, #2c2418, #3d3224);
  color: #f5f0e8;
  position: relative;
}
.profile-header .gender-icon {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: rgba(139,105,20,0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  margin-bottom: 1rem;
  border: 2px solid rgba(196,164,74,0.4);
}
.profile-name {
  font-family: 'Cormorant Garamond', serif;
  font-size: 2rem;
  font-weight: 600;
  line-height: 1.2;
}
.profile-dates {
  color: #c4a44a;
  font-size: 1.05rem;
  margin-top: 0.3rem;
  font-weight: 300;
}
.profile-branch {
  display: inline-block;
  margin-top: 0.8rem;
  padding: 0.25rem 0.8rem;
  border-radius: 6px;
  font-size: 0.8rem;
  font-weight: 500;
  letter-spacing: 0.05em;
}

/* Branch colors */
.branch-Owen { background: rgba(184,134,11,0.25); color: #b8860b; }
.branch-Wells { background: rgba(70,130,180,0.25); color: #4682b4; }
.branch-Bonnie { background: rgba(180,74,74,0.25); color: #b44a4a; }
.branch-Eastman { background: rgba(122,74,154,0.25); color: #7a4a9a; }
.branch-Lunde { background: rgba(74,154,154,0.25); color: #4a9a9a; }
.branch-Murphy { background: rgba(196,134,74,0.25); color: #c4864a; }
.branch-Nelson { background: rgba(74,154,106,0.25); color: #4a9a6a; }

.profile-body {
  padding: 2rem;
}

.profile-section-block {
  margin-bottom: 2rem;
}
.profile-section-block:last-child { margin-bottom: 0; }

.section-title {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.3rem;
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid var(--border-light);
}

.field-grid {
  display: grid;
  gap: 0.8rem;
}
.field-row {
  display: flex;
  justify-content: space-between;
  padding: 0.5rem 0;
  border-bottom: 1px solid var(--border-light);
}
.field-row:last-child { border-bottom: none; }
.field-label {
  font-weight: 500;
  color: var(--text-muted);
  flex-shrink: 0;
  margin-right: 1rem;
}
.field-value {
  color: var(--text);
  text-align: right;
  flex: 1;
}
.field-value.link {
  color: var(--accent);
  cursor: pointer;
  text-decoration: underline;
}
.field-value.link:hover {
  color: var(--text);
}

.notes-box {
  background: var(--bg);
  border-left: 3px solid var(--accent);
  padding: 1rem;
  border-radius: 6px;
  font-size: 0.9rem;
  line-height: 1.7;
  color: var(--text-muted);
}

.military-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.4rem 0.8rem;
  background: rgba(139,58,58,0.1);
  border: 1px solid rgba(139,58,58,0.3);
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 500;
  color: var(--danger);
}
.immigration-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.4rem 0.8rem;
  background: rgba(58,130,139,0.1);
  border: 1px solid rgba(58,130,139,0.3);
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 500;
  color: var(--info);
}

/* ===== ACTION BUTTONS ===== */
.action-buttons {
  display: flex;
  gap: 0.8rem;
  margin-top: 1.5rem;
  flex-wrap: wrap;
}
.action-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.7rem 1.2rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}
.action-btn:hover:not(:disabled) {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
  transform: translateY(-1px);
}
.action-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.action-btn svg {
  width: 18px;
  height: 18px;
}
.action-btn.primary {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}
.action-btn.primary:hover:not(:disabled) {
  background: var(--text);
  border-color: var(--text);
}

/* ===== RESEARCH SECTION ===== */
.research-section {
  margin-top: 2rem;
  display: none;
}
.research-section.active { display: block; }

.research-container {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(44,36,24,0.08);
}

.research-loading {
  padding: 3rem 2rem;
  text-align: center;
}
.loading-spinner {
  width: 48px;
  height: 48px;
  border: 4px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 1.5rem;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
.loading-text {
  font-size: 1.1rem;
  font-weight: 500;
  color: var(--text);
  margin-bottom: 1.5rem;
}
.loading-steps {
  max-width: 400px;
  margin: 0 auto;
  text-align: left;
}
.loading-step {
  padding: 0.6rem 1rem;
  margin-bottom: 0.5rem;
  background: var(--bg);
  border-radius: 6px;
  font-size: 0.9rem;
  color: var(--text-muted);
  border-left: 3px solid var(--border);
}
.loading-step.active {
  border-left-color: var(--accent);
  color: var(--text);
  font-weight: 500;
}
.loading-step.done {
  border-left-color: var(--success);
  color: var(--success);
}

.research-results {
  padding: 0;
}
.research-header {
  padding: 1.5rem 2rem;
  background: linear-gradient(135deg, var(--bg-dark), var(--bg));
  border-bottom: 2px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.research-header h3 {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--accent);
}
.confidence-badge {
  padding: 0.3rem 0.8rem;
  border-radius: 6px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.confidence-high {
  background: rgba(74,124,89,0.15);
  color: var(--success);
}
.confidence-medium {
  background: rgba(139,105,20,0.15);
  color: var(--accent);
}
.confidence-low {
  background: rgba(139,58,58,0.15);
  color: var(--danger);
}

.research-body {
  padding: 2rem;
  line-height: 1.8;
}
.research-body h4 {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--accent);
  margin: 1.5rem 0 0.8rem;
}
.research-body h4:first-child { margin-top: 0; }
.research-body p {
  margin-bottom: 1rem;
  color: var(--text);
}
.research-body ul, .research-body ol {
  margin-left: 1.5rem;
  margin-bottom: 1rem;
}
.research-body li {
  margin-bottom: 0.5rem;
  color: var(--text);
}
.research-body strong {
  color: var(--accent);
  font-weight: 600;
}
.research-body blockquote {
  border-left: 3px solid var(--accent);
  padding-left: 1rem;
  margin: 1rem 0;
  color: var(--text-muted);
  font-style: italic;
}

.research-footer {
  padding: 1rem 2rem;
  background: var(--bg-dark);
  border-top: 1px solid var(--border);
  font-size: 0.8rem;
  color: var(--text-muted);
  display: flex;
  justify-content: space-between;
}

/* ===== SEARCH LINK CARDS ===== */
.research-intro {
  background: var(--accent-glow);
  padding: 1rem;
  border-radius: 8px;
  margin-bottom: 1.5rem;
  border-left: 3px solid var(--accent);
}
.search-links {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}
.search-link-card {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 1.2rem;
  display: flex;
  gap: 1rem;
  align-items: flex-start;
  transition: all 0.2s;
}
.search-link-card:hover {
  border-color: var(--accent);
  box-shadow: 0 4px 12px rgba(139,105,20,0.15);
  transform: translateY(-2px);
}
.search-link-number {
  background: var(--accent);
  color: #fff;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 0.9rem;
  flex-shrink: 0;
}
.search-link-content {
  flex: 1;
}
.search-link-title {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.1rem;
  color: var(--text);
  margin-bottom: 0.3rem;
  font-weight: 600;
}
.search-link-desc {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-bottom: 0.8rem;
  line-height: 1.5;
}
.search-link-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.5rem 1rem;
  background: var(--accent);
  color: #fff;
  text-decoration: none;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 500;
  transition: all 0.2s;
}
.search-link-btn:hover {
  background: var(--text);
  transform: translateX(2px);
}
.search-link-btn svg {
  width: 14px;
  height: 14px;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
  .main-container {
    padding: 1rem;
  }
  .site-title {
    font-size: 1.8rem;
  }
  .profile-name {
    font-size: 1.6rem;
  }
  .quick-picks-grid {
    grid-template-columns: 1fr;
  }
  .field-row {
    flex-direction: column;
    gap: 0.3rem;
  }
  .field-value {
    text-align: left;
  }
  .action-buttons {
    flex-direction: column;
  }
  .action-btn {
    width: 100%;
    justify-content: center;
  }
  .research-header {
    flex-direction: column;
    gap: 0.5rem;
    align-items: flex-start;
  }
  .search-link-card {
    flex-direction: column;
  }
}
</style>
<script src="data-loader.js"></script>
</head>
<body>

<div class="home-nav">
  <a href="index.html" class="home-btn">‚Üê Return to Home</a>
</div>

<header class="site-header">
  <div class="header-content">
    <h1 class="site-title">Owen Family <span>Research</span></h1>
    <p class="site-subtitle">Deep dive into individual family members with AI-powered research</p>
  </div>
</header>

<main class="main-container">
  <!-- SEARCH SECTION -->
  <section class="search-section">
    <div class="search-box-wrapper">
      <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
      </svg>
      <input 
        type="text" 
        class="search-input" 
        id="searchInput" 
        placeholder="Search by name (e.g., John Owen, Mary Wells)..."
        autocomplete="off"
      />
      <div class="search-results-dropdown" id="searchResults"></div>
    </div>

    <!-- QUICK PICKS -->
    <div class="quick-picks">
      <div class="quick-picks-label">Notable Family Members with Rich History</div>
      <div class="quick-picks-grid" id="quickPicks"></div>
    </div>
  </section>

  <!-- PROFILE SECTION -->
  <section class="profile-section" id="profileSection">
    <div class="profile-card">
      <div class="profile-header" id="profileHeader"></div>
      <div class="profile-body" id="profileBody"></div>
    </div>
  </section>

  <!-- RESEARCH SECTION -->
  <section class="research-section" id="researchSection">
    <div class="research-container" id="researchContent"></div>
  </section>
</main>

<script>
let PEOPLE = [];
const peopleMap = {};
let selectedPerson = null;
const researchCache = {};

// ===== INIT =====
async function initQuickPicks() {
  try {
    const db = owenFamilyDB;
    const data = await db.getData();
    
    if (!data.people || data.people.length === 0) {
      throw new Error('No records returned from database');
    }
    
    PEOPLE = data.people;
    PEOPLE.forEach(p => { peopleMap[p.id] = p; });

    // Build quick picks - score each person for "interestingness"
    const scoredPeople = PEOPLE.map(p => {
      let score = 0;
      
      // Points for having rich data
      if (p.military) score += 10;
      if (p.war) score += 5;
      if (p.immigrationYear) score += 8;
      if (p.occupation) score += 3;
      if (p.notes && p.notes.length > 50) score += 7;
      if (p.burialPlace) score += 2;
      if (p.employers) score += 2;
      if (p.undergradUniv) score += 3;
      if (p.gradUniv) score += 3;
      if (p.flyFishing) score += 2;
      
      // Points for being historically significant (older)
      if (p.birthYear) {
        if (p.birthYear < 1700) score += 15;
        else if (p.birthYear < 1800) score += 10;
        else if (p.birthYear < 1900) score += 5;
      }
      
      // Points for early generations
      if (p.generationNumber != null && p.generationNumber <= 5) score += 8;
      
      // Points for having complete family data
      if (p.fatherId && p.motherId) score += 2;
      if (p.spouseIds && p.spouseIds.length > 0) score += 2;
      
      return { person: p, score: score };
    });
    
    // Sort by score and take top 8
    const quickPicks = scoredPeople
      .sort((a, b) => b.score - a.score)
      .slice(0, 8)
      .map(item => item.person);

    const grid = document.getElementById('quickPicks');
    grid.innerHTML = quickPicks.map(p => {
      const badges = [];
      if (p.military) badges.push('üéñÔ∏è Military');
      if (p.immigrationYear) badges.push('üõ≥Ô∏è Immigrant');
      if (p.generationNumber != null && p.generationNumber <= 3) badges.push('üå≥ Early Gen');
      
      return `
        <div class="quick-pick-card" onclick="selectPerson('${p.id}')">
          <div class="quick-pick-name">${escapeHtml(p.fullName || p.firstName + ' ' + p.lastName)}</div>
          <div class="quick-pick-dates">${formatDates(p)}</div>
          ${badges.length > 0 ? `<div style="font-size:0.7rem;margin-top:0.3rem;color:var(--accent)">${badges.join(' ¬∑ ')}</div>` : ''}
        </div>
      `;
    }).join('');

    // Setup search
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');

    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.trim().toLowerCase();
      if (query.length < 2) {
        searchResults.classList.remove('active');
        return;
      }

      const matches = PEOPLE.filter(p => {
        const fullName = (p.fullName || p.firstName + ' ' + p.lastName).toLowerCase();
        const maidenName = (p.maidenName || '').toLowerCase();
        return fullName.includes(query) || maidenName.includes(query);
      }).slice(0, 10);

      if (matches.length === 0) {
        searchResults.innerHTML = '<div class="search-result-item"><div class="name">No results found</div></div>';
        searchResults.classList.add('active');
        return;
      }

      searchResults.innerHTML = matches.map(p => `
        <div class="search-result-item" onclick="selectPerson('${p.id}'); document.getElementById('searchInput').value=''; document.getElementById('searchResults').classList.remove('active');">
          <div class="name">${escapeHtml(p.fullName || p.firstName + ' ' + p.lastName)}</div>
          <div class="meta">
            ${formatDates(p)}
            ${p.branchLineage ? `<span class="branch-tag branch-${p.branchLineage}">${p.branchLineage}</span>` : ''}
          </div>
        </div>
      `).join('');
      searchResults.classList.add('active');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-box-wrapper')) {
        searchResults.classList.remove('active');
      }
    });

  } catch (error) {
    console.error('Failed to load family data:', error);
    document.getElementById('quickPicks').innerHTML = '<p>Unable to load family data. Please refresh the page.</p>';
  }
}

// ===== SELECT PERSON =====
function selectPerson(personId) {
  const p = peopleMap[personId];
  if (!p) return;

  selectedPerson = p;

  // Scroll to profile
  document.getElementById('profileSection').scrollIntoView({ behavior: 'smooth', block: 'start' });

  // Build profile header
  const genderIcon = p.gender === 'M' ? 'üë®' : 'üë©';
  const branchClass = p.branchLineage ? `branch-${p.branchLineage}` : '';

  document.getElementById('profileHeader').innerHTML = `
    <div class="gender-icon">${genderIcon}</div>
    <div class="profile-name">${escapeHtml(p.fullName || p.firstName + ' ' + p.lastName)}</div>
    <div class="profile-dates">${formatDates(p)}</div>
    ${p.branchLineage ? `<span class="profile-branch ${branchClass}">${p.branchLineage} Branch</span>` : ''}
  `;

  // Build profile body
  let bodyHtml = '';

  // Basic Info
  bodyHtml += '<div class="profile-section-block">';
  bodyHtml += '<h3 class="section-title">Basic Information</h3>';
  bodyHtml += '<div class="field-grid">';
  if (p.fullName) bodyHtml += fieldRow('Full Name', p.fullName);
  if (p.title) bodyHtml += fieldRow('Title', p.title);
  if (p.nickname) bodyHtml += fieldRow('Nickname', p.nickname);
  if (p.maidenName) bodyHtml += fieldRow('Maiden Name', p.maidenName);
  bodyHtml += fieldRow('Gender', p.gender === 'M' ? 'Male' : 'Female');
  if (p.birthYear) {
    const birthLoc = [p.birthCity, p.birthState, p.birthCountry].filter(Boolean).join(', ');
    bodyHtml += fieldRow('Born', p.birthYear + (birthLoc ? ', ' + birthLoc : ''));
  }
  if (p.deathYear) {
    const deathLoc = [p.deathCity, p.deathState, p.deathCountry].filter(Boolean).join(', ');
    bodyHtml += fieldRow('Died', p.deathYear + (deathLoc ? ', ' + deathLoc : ''));
  }
  if (p.ageAtDeath && p.ageAtDeath !== 'Alive') bodyHtml += fieldRow('Age at Death', p.ageAtDeath);
  if (p.burialPlace) bodyHtml += fieldRow('Burial Place', p.burialPlace);
  if (p.residenceCity || p.residenceState || p.residenceCountry) {
    const resLoc = [p.residenceCity, p.residenceState, p.residenceCountry].filter(Boolean).join(', ');
    bodyHtml += fieldRow('Current Residence', resLoc);
  }
  bodyHtml += '</div></div>';

  // Family
  bodyHtml += '<div class="profile-section-block">';
  bodyHtml += '<h3 class="section-title">Family</h3>';
  bodyHtml += '<div class="field-grid">';
  if (p.fatherId && peopleMap[p.fatherId]) {
    const f = peopleMap[p.fatherId];
    bodyHtml += fieldRowLink('Father', f.fullName || f.firstName + ' ' + f.lastName, f.id);
  }
  if (p.motherId && peopleMap[p.motherId]) {
    const m = peopleMap[p.motherId];
    bodyHtml += fieldRowLink('Mother', m.fullName || m.firstName + ' ' + m.lastName, m.id);
  }
  if (p.stepParent) bodyHtml += fieldRow('Step Parent', p.stepParent);
  if (p.spouseIds?.length) {
    p.spouseIds.forEach(sid => {
      const sp = peopleMap[sid];
      if (sp) bodyHtml += fieldRowLink('Spouse', sp.fullName || sp.firstName + ' ' + sp.lastName, sp.id);
    });
  }
  if (p.childrenIds?.length) {
    bodyHtml += fieldRow('Children', p.childrenIds.length + ' child' + (p.childrenIds.length !== 1 ? 'ren' : ''));
  }
  if (p.siblingIds?.length) {
    bodyHtml += fieldRow('Siblings', p.siblingIds.length + ' sibling' + (p.siblingIds.length !== 1 ? 's' : ''));
  }
  if (p.generationNumber != null) bodyHtml += fieldRow('Generation', 'Gen ' + p.generationNumber + ' from Aurora');
  if (p.relationship) bodyHtml += fieldRow('Relationship', p.relationship);
  bodyHtml += '</div></div>';

  // Life Details
  if (p.occupation || p.employers || p.undergradUniv || p.gradUniv || p.fraternity || p.sports || p.flyFishing || p.military || p.immigrationYear) {
    bodyHtml += '<div class="profile-section-block">';
    bodyHtml += '<h3 class="section-title">Life Details</h3>';
    bodyHtml += '<div class="field-grid">';
    if (p.occupation) bodyHtml += fieldRow('Occupation', p.occupation);
    if (p.employers) bodyHtml += fieldRow('Employers', p.employers);
    if (p.undergradUniv) bodyHtml += fieldRow('Undergraduate', p.undergradUniv + (p.undergradYear ? ' (' + p.undergradYear + ')' : ''));
    if (p.gradUniv) bodyHtml += fieldRow('Graduate School', p.gradUniv + (p.gradYear ? ' (' + p.gradYear + ')' : ''));
    if (p.fraternity) bodyHtml += fieldRow('Fraternity/Sorority', p.fraternity);
    if (p.sports) bodyHtml += fieldRow('Sports', p.sports);
    if (p.flyFishing) bodyHtml += fieldRow('Fly Fishing', p.flyFishing);
    if (p.immigrationYear) {
      bodyHtml += '<div class="immigration-badge" style="margin-top:0.5rem">üõ≥Ô∏è Immigrated to USA in ' + p.immigrationYear + '</div>';
    }
    if (p.generationAmerican) bodyHtml += fieldRow('Generation American', p.generationAmerican);
    if (p.military) {
      const milDetails = [p.militaryBranch, p.war].filter(Boolean).join(' ¬∑ ');
      const served = p.servedFrom ? `${p.servedFrom}‚Äì${p.servedTo || 'present'}` : '';
      bodyHtml += `<div class="military-badge" style="margin-top:0.5rem">üéñÔ∏è ${milDetails}${served ? ' (' + served + ')' : ''}</div>`;
    }
    bodyHtml += '</div></div>';
  }

  // Additional Information
  if (p.photoLink || p.infoLink || p.dnaMatchId || p.confidence) {
    bodyHtml += '<div class="profile-section-block">';
    bodyHtml += '<h3 class="section-title">Additional Information</h3>';
    bodyHtml += '<div class="field-grid">';
    if (p.confidence) bodyHtml += fieldRow('Record Confidence', p.confidence);
    if (p.dnaMatchId) bodyHtml += fieldRow('DNA Match ID', p.dnaMatchId);
    if (p.photoLink) {
      bodyHtml += `<div class="field-row"><span class="field-label">Photo/Document</span><span class="field-value"><a href="${p.photoLink}" target="_blank" style="color:var(--accent);text-decoration:underline">View Link</a></span></div>`;
    }
    if (p.infoLink) {
      bodyHtml += `<div class="field-row"><span class="field-label">Information Link</span><span class="field-value"><a href="${p.infoLink}" target="_blank" style="color:var(--accent);text-decoration:underline">View Link</a></span></div>`;
    }
    bodyHtml += '</div></div>';
  }

  // Notes
  if (p.notes) {
    bodyHtml += '<div class="profile-section-block">';
    bodyHtml += '<h3 class="section-title">Family Notes & Stories</h3>';
    bodyHtml += `<div class="notes-box">${escapeHtml(p.notes)}</div>`;
    bodyHtml += '</div>';
  }

  // Action buttons
  bodyHtml += '<div class="action-buttons">';
  bodyHtml += `<button class="action-btn primary" id="researchBtn" onclick="doResearch()">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"/>
      <line x1="21" y1="21" x2="16.65" y2="16.65"/>
    </svg>
    Research This Person
  </button>`;
  bodyHtml += '</div>';

  document.getElementById('profileBody').innerHTML = bodyHtml;
  document.getElementById('profileSection').classList.add('active');
  
  // Hide research section
  document.getElementById('researchSection').classList.remove('active');
}

// ===== HELPERS =====
function fieldRow(label, value) {
  return `<div class="field-row"><span class="field-label">${label}</span><span class="field-value">${escapeHtml(String(value))}</span></div>`;
}
function fieldRowLink(label, value, id) {
  return `<div class="field-row"><span class="field-label">${label}</span><span class="field-value link" onclick="selectPerson('${id}')">${escapeHtml(String(value))}</span></div>`;
}

function formatDates(p) {
  const parts = [];
  if (p.birthYear) parts.push('b. ' + p.birthYear);
  if (p.deathYear) parts.push('d. ' + p.deathYear);
  else if (p.ageAtDeath === 'Alive') parts.push('living');
  const loc = [p.birthCity, p.birthState].filter(Boolean).join(', ');
  if (loc) parts.push(loc);
  return parts.join(' ¬∑ ');
}

function escapeHtml(s) {
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}

// ===== RESEARCH =====
async function doResearch() {
  if (!selectedPerson) return;
  const p = selectedPerson;

  // Check cache
  if (researchCache[p.id]) {
    showResearchResults(researchCache[p.id]);
    return;
  }

  const btn = document.getElementById('researchBtn');
  btn.disabled = true;
  btn.innerHTML = `<span class="loading-spinner" style="width:18px;height:18px;border-width:2px;display:inline-block;vertical-align:middle;margin:0;"></span> Researching‚Ä¶`;

  const section = document.getElementById('researchSection');
  section.classList.add('active');

  document.getElementById('researchContent').innerHTML = `
    <div class="research-loading">
      <div class="loading-spinner"></div>
      <div class="loading-text">Researching ${escapeHtml(p.fullName || p.firstName)}‚Ä¶</div>
      <div class="loading-steps">
        <div class="loading-step active" id="step1">‚è≥ Building search queries‚Ä¶</div>
        <div class="loading-step" id="step2">‚è≥ Searching genealogy records‚Ä¶</div>
        <div class="loading-step" id="step3">‚è≥ Compiling results‚Ä¶</div>
      </div>
    </div>
  `;

  // Animate steps
  setTimeout(() => {
    document.getElementById('step1').className = 'loading-step done';
    document.getElementById('step1').textContent = '‚úì Search queries built';
    document.getElementById('step2').className = 'loading-step active';
  }, 1000);
  setTimeout(() => {
    document.getElementById('step2').className = 'loading-step done';
    document.getElementById('step2').textContent = '‚úì Records searched';
    document.getElementById('step3').className = 'loading-step active';
  }, 2000);

  // Build search queries
  const searches = buildSearchQueries(p);
  
  const result = {
    searches: searches,
    timestamp: new Date().toISOString(),
    personId: p.id
  };

  researchCache[p.id] = result;
  
  setTimeout(() => {
    showResearchResults(result);
    btn.disabled = false;
    btn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Research This Person`;
  }, 3000);
}

function buildSearchQueries(p) {
  const queries = [];
  const fullName = p.fullName || `${p.firstName} ${p.lastName}`;
  const birthYear = p.birthYear || '';
  const deathYear = p.deathYear || '';
  const birthPlace = [p.birthCity, p.birthState].filter(Boolean).join(' ');
  const deathPlace = [p.deathCity, p.deathState].filter(Boolean).join(' ');

  // 1. FindAGrave search
  if (deathYear || p.burialPlace) {
    queries.push({
      title: 'FindAGrave Records',
      url: `https://www.findagrave.com/memorial/search?firstname=${encodeURIComponent(p.firstName)}&lastname=${encodeURIComponent(p.lastName)}&birthyear=${birthYear}&deathyear=${deathYear}`,
      description: 'Search for burial records, cemetery information, and memorial pages'
    });
  }

  // 2. FamilySearch search
  queries.push({
    title: 'FamilySearch Records',
    url: `https://www.familysearch.org/search/record/results?q.givenName=${encodeURIComponent(p.firstName)}&q.surname=${encodeURIComponent(p.lastName)}&q.birthLikeYear=${birthYear}&q.deathLikeYear=${deathYear}`,
    description: 'Search vital records, census data, and family trees'
  });

  // 3. Ancestry search
  queries.push({
    title: 'Ancestry Records',
    url: `https://www.ancestry.com/search/?name=${encodeURIComponent(p.firstName)}_${encodeURIComponent(p.lastName)}&birth=${birthYear}&death=${deathYear}`,
    description: 'Search historical records and family trees (requires subscription)'
  });

  // 4. Military records (if applicable)
  if (p.military) {
    const war = p.war || '';
    queries.push({
      title: 'Military Service Records',
      url: `https://www.google.com/search?q=${encodeURIComponent(`"${fullName}" ${war} ${p.militaryBranch || ''} military service records`)}`,
      description: `Search for ${war} service records and unit information`
    });
  }

  // 5. Census records
  if (birthYear) {
    const censusYears = [];
    for (let year = 1790; year <= 1940; year += 10) {
      const age = year - birthYear;
      if (age >= 0 && age <= 100) {
        censusYears.push(year);
      }
    }
    if (censusYears.length > 0) {
      queries.push({
        title: 'US Census Records',
        url: `https://www.google.com/search?q=${encodeURIComponent(`"${fullName}" census ${censusYears.join(' OR ')} ${birthPlace}`)}`,
        description: `Possible census years: ${censusYears.join(', ')}`
      });
    }
  }

  // 6. Immigration records (if applicable)
  if (p.immigrationYear) {
    queries.push({
      title: 'Immigration Records',
      url: `https://www.google.com/search?q=${encodeURIComponent(`"${fullName}" ${p.immigrationYear} immigration ship passenger manifest`)}`,
      description: `Search for passenger manifests and immigration documents from ${p.immigrationYear}`
    });
  }

  // 7. Historical newspapers
  queries.push({
    title: 'Historical Newspapers',
    url: `https://chroniclingamerica.loc.gov/search/pages/results/?state=&date1=${birthYear}&date2=${deathYear}&proxtext=${encodeURIComponent(fullName)}`,
    description: 'Search Library of Congress digitized newspapers (1777-1963)'
  });

  // 8. Google Books
  queries.push({
    title: 'Historical Books & Publications',
    url: `https://www.google.com/search?q=${encodeURIComponent(`"${fullName}" ${birthYear} ${birthPlace}`)}+site:books.google.com`,
    description: 'Search for mentions in published genealogies and historical books'
  });

  // 9. General web search
  queries.push({
    title: 'General Web Search',
    url: `https://www.google.com/search?q=${encodeURIComponent(`"${fullName}" ${birthYear} ${deathYear} ${birthPlace} genealogy`)}`,
    description: 'Broad search for any online mentions or family histories'
  });

  // 10. Historical context search
  if (birthYear && birthPlace) {
    queries.push({
      title: 'Historical Context',
      url: `https://www.google.com/search?q=${encodeURIComponent(`${birthPlace} history ${birthYear}-${deathYear || parseInt(birthYear) + 70}`)}`,
      description: `Learn about life in ${birthPlace} during their lifetime`
    });
  }

  return queries;
}

function showResearchResults(result) {
  const section = document.getElementById('researchSection');
  section.classList.add('active');

  const timestamp = new Date(result.timestamp).toLocaleString();

  let html = '<div class="research-intro"><p>Below are curated search links to help you research this person across major genealogy databases and historical records.</p></div>';
  
  html += '<div class="search-links">';
  result.searches.forEach((search, idx) => {
    html += `
      <div class="search-link-card">
        <div class="search-link-number">${idx + 1}</div>
        <div class="search-link-content">
          <h4 class="search-link-title">${escapeHtml(search.title)}</h4>
          <p class="search-link-desc">${escapeHtml(search.description)}</p>
          <a href="${search.url}" target="_blank" class="search-link-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
              <polyline points="15 3 21 3 21 9"/>
              <line x1="10" y1="14" x2="21" y2="3"/>
            </svg>
            Open Search
          </a>
        </div>
      </div>
    `;
  });
  html += '</div>';

  document.getElementById('researchContent').innerHTML = `
    <div class="research-results">
      <div class="research-header">
        <h3>Research Resources</h3>
        <span class="confidence-badge confidence-high">üîç ${result.searches.length} Search Links</span>
      </div>
      <div class="research-body">${html}</div>
      <div class="research-footer">
        <span>Generated ${timestamp}</span>
      </div>
    </div>
  `;
}

// ===== INIT =====
initQuickPicks();
</script>
</body>
</html>
