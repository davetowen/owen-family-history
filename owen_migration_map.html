<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Owen Family — Migration Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,500&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f0e8;
  --bg-card: #faf7f2;
  --bg-dark: #eee8db;
  --accent: #8b6914;
  --accent-light: #c4a44a;
  --accent-glow: rgba(139,105,20,0.12);
  --text: #2c2418;
  --text-muted: #6b5d4d;
  --text-light: #9a8b78;
  --border: #d9cdb8;
  --border-light: #e8dece;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  height: 100%;
  overflow: hidden;
}

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  flex-direction: column;
}

.home-nav {
  padding: 1rem 2rem;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
}

.home-btn {
  display: inline-block;
  padding: 0.5rem 1rem;
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text);
  text-decoration: none;
  border-radius: 6px;
  font-size: 0.9rem;
  transition: all 0.2s;
}

.home-btn:hover {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
  transform: translateY(-1px);
}

.site-header {
  background: linear-gradient(135deg, #2c2418 0%, #3d3224 50%, #2c2418 100%);
  padding: 1.5rem 2rem;
  position: relative;
  flex-shrink: 0;
}

.site-header::before {
  content: '';
  position: absolute;
  inset: 0;
  background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
}

.header-content {
  max-width: 1200px;
  margin: 0 auto;
  position: relative;
  z-index: 1;
}

.site-title {
  font-family: 'Cormorant Garamond', serif;
  font-weight: 300;
  font-size: 2.2rem;
  color: #f5f0e8;
  letter-spacing: 0.02em;
}

.site-title span {
  color: var(--accent-light);
  font-weight: 600;
}

.site-subtitle {
  color: #9a8b78;
  font-size: 0.9rem;
  margin-top: 0.3rem;
  font-weight: 300;
}

.map-container {
  flex: 1;
  position: relative;
  overflow: hidden;
}

#map {
  width: 100%;
  height: 100%;
}

.map-controls {
  position: absolute;
  top: 1rem;
  right: 1rem;
  z-index: 1000;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 1rem;
  box-shadow: 0 4px 16px rgba(44,36,24,0.1);
  max-width: 280px;
}

.controls-title {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 0.8rem;
}

.control-group {
  margin-bottom: 0.8rem;
}

.control-label {
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-bottom: 0.3rem;
  display: block;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

select, input[type="range"] {
  width: 100%;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.85rem;
  padding: 0.4rem 0.6rem;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg);
  color: var(--text);
  outline: none;
}

select:focus {
  border-color: var(--accent);
}

.map-legend {
  position: absolute;
  bottom: 1rem;
  left: 1rem;
  z-index: 1000;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 1rem;
  box-shadow: 0 4px 16px rgba(44,36,24,0.1);
}

.legend-title {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1rem;
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 0.6rem;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.4rem;
  font-size: 0.8rem;
  color: var(--text-muted);
}

.legend-marker {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 2px solid #fff;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.marker-birth { background: #4a7c59; }
.marker-death { background: #8b3a3a; }
.marker-residence { background: #c4a44a; }

.stats-panel {
  position: absolute;
  top: 1rem;
  left: 1rem;
  z-index: 1000;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 0.8rem 1rem;
  box-shadow: 0 4px 16px rgba(44,36,24,0.1);
  display: flex;
  gap: 1.5rem;
}

.stat-item {
  text-align: center;
}

.stat-value {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--accent);
  line-height: 1;
}

.stat-label {
  font-size: 0.7rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-top: 0.2rem;
}

.leaflet-popup-content-wrapper {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 0;
}

.leaflet-popup-content {
  margin: 0;
  padding: 1rem;
  font-family: 'DM Sans', sans-serif;
}

.popup-title {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 0.5rem;
}

.popup-detail {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-bottom: 0.3rem;
}

.loading {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  z-index: 2000;
  background: var(--bg-card);
  padding: 2rem;
  border-radius: 10px;
  border: 1px solid var(--border);
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 1rem;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

@media (max-width: 768px) {
  .map-controls {
    max-width: 200px;
    padding: 0.8rem;
  }
  
  .stats-panel {
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .site-title {
    font-size: 1.8rem;
  }
}
</style>
<script src="data-loader.js"></script>
</head>
<body>

<div class="home-nav"><a href="index.html" class="home-btn">← Return to Home</a></div>

<header class="site-header">
  <div class="header-content">
    <h1 class="site-title">Owen Family <span>Migration Map</span></h1>
    <p class="site-subtitle">Trace family movements across continents and generations</p>
  </div>
</header>

<div class="map-container">
  <div id="map"></div>
  
  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
    <p>Loading family data from Google Sheets...</p>
  </div>
  
  <div class="stats-panel">
    <div class="stat-item">
      <div class="stat-value" id="locationCount">0</div>
      <div class="stat-label">Locations</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="peopleCount">0</div>
      <div class="stat-label">People</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="countryCount">0</div>
      <div class="stat-label">Countries</div>
    </div>
  </div>
  
  <div class="map-controls">
    <div class="controls-title">Filters</div>
    
    <div class="control-group">
      <label class="control-label">Branch</label>
      <select id="branchFilter">
        <option value="all">All Branches</option>
        <option value="Owen">Owen</option>
        <option value="Bonnie">Bonnie</option>
        <option value="Lunde">Lunde</option>
        <option value="Murphy">Murphy</option>
      </select>
    </div>
    
    <div class="control-group">
      <label class="control-label">Event Type</label>
      <select id="eventFilter">
        <option value="all">All Events</option>
        <option value="birth">Births</option>
        <option value="death">Deaths</option>
        <option value="residence">Residences</option>
      </select>
    </div>
    
    <div class="control-group">
      <label class="control-label">Time Period</label>
      <select id="timeFilter">
        <option value="all">All Years</option>
        <option value="1200-1500">1200-1500</option>
        <option value="1500-1700">1500-1700</option>
        <option value="1700-1800">1700-1800</option>
        <option value="1800-1900">1800-1900</option>
        <option value="1900-2000">1900-2000</option>
        <option value="2000-2025">2000-2025</option>
      </select>
    </div>
  </div>
  
  <div class="map-legend">
    <div class="legend-title">Legend</div>
    <div class="legend-item">
      <div class="legend-marker marker-birth"></div>
      <span>Birth Location</span>
    </div>
    <div class="legend-item">
      <div class="legend-marker marker-death"></div>
      <span>Death Location</span>
    </div>
    <div class="legend-item">
      <div class="legend-marker marker-residence"></div>
      <span>Residence</span>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map;
let markers = [];
let allPeople = [];
let activeBranch = 'all';
let activeEvent = 'all';
let activeTimeRange = 'all';
let geocodeCache = {};
let lastGeocode = 0;
const GEOCODE_DELAY = 1100;

async function geocodeLocation(city, state, country) {
  const cacheKey = `${city}|${state}|${country}`.toLowerCase();
  
  if (geocodeCache[cacheKey]) {
    return geocodeCache[cacheKey];
  }
  
  let query = [];
  if (city && city !== 'Unknown') query.push(city);
  if (state && state !== 'Unknown') query.push(state);
  if (country && country !== 'Unknown') query.push(country);
  
  if (query.length === 0) return null;
  
  const searchQuery = query.join(', ');
  
  const now = Date.now();
  const timeSinceLastRequest = now - lastGeocode;
  if (timeSinceLastRequest < GEOCODE_DELAY) {
    await new Promise(resolve => setTimeout(resolve, GEOCODE_DELAY - timeSinceLastRequest));
  }
  
  try {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=1`;
    const response = await fetch(url, {
      headers: {
        'User-Agent': 'Owen Family History Website'
      }
    });
    
    lastGeocode = Date.now();
    
    if (!response.ok) return null;
    
    const data = await response.json();
    
    if (data && data.length > 0) {
      const result = {
        lat: parseFloat(data[0].lat),
        lng: parseFloat(data[0].lon)
      };
      
      geocodeCache[cacheKey] = result;
      return result;
    }
  } catch (error) {
    console.error('Geocoding error:', error);
  }
  
  geocodeCache[cacheKey] = null;
  return null;
}

function initMap() {
  map = L.map('map').setView([40, -20], 3);
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors',
    maxZoom: 18
  }).addTo(map);
  
  loadDataAndGeocode();
}

async function loadDataAndGeocode() {
  try {
    // Use the global owenFamilyDB instance from data-loader.js (SAME AS TREE PAGE)
    const db = owenFamilyDB;
    const data = await db.getData();
    
    if (!data.people || data.people.length === 0) {
      throw new Error('No records returned from database');
    }
    
    console.log('Migration map loaded: ' + data.people.length + ' people');
    
    // Map to allPeople array
    allPeople = data.people.map(person => ({
      ...person,
      branch: person.branchLineage
    }));
    
    document.getElementById('loading').innerHTML = `
      <div class="loading-spinner"></div>
      <p>Geocoding locations... This may take a few minutes.</p>
      <p style="font-size: 0.85rem; margin-top: 0.5rem; color: var(--text-muted);">
        Progress: <span id="geocodeProgress">0</span> / ${allPeople.length}
      </p>
    `;
    
    let geocoded = 0;
    for (let person of allPeople) {
      if (person.birthCity || person.birthCountry) {
        const birthCoords = await geocodeLocation(
          person.birthCity,
          person.birthState,
          person.birthCountry
        );
        if (birthCoords) {
          person.birthLat = birthCoords.lat;
          person.birthLng = birthCoords.lng;
        }
      }
      
      if (person.deathCity || person.deathCountry) {
        const deathCoords = await geocodeLocation(
          person.deathCity,
          person.deathState,
          person.deathCountry
        );
        if (deathCoords) {
          person.deathLat = deathCoords.lat;
          person.deathLng = deathCoords.lng;
        }
      }
      
      geocoded++;
      document.getElementById('geocodeProgress').textContent = geocoded;
    }
    
    document.getElementById('loading').style.display = 'none';
    renderMap();
    
  } catch (error) {
    console.error('Failed to load family data:', error);
    document.getElementById('loading').innerHTML = `
      <div>
        <h2 style="color: var(--accent); margin-bottom: 0.5rem;">Unable to Load Family Data</h2>
        <p>Could not connect to the Google Sheets database.</p>
        <p style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--text-muted);">${error.message}</p>
        <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--accent); color: #fff; border: none; border-radius: 6px; cursor: pointer;">Retry</button>
      </div>
    `;
  }
}

function renderMap() {
  markers.forEach(m => m.remove());
  markers = [];
  
  let filteredPeople = allPeople.filter(person => {
    if (activeBranch !== 'all' && person.branch !== activeBranch) {
      return false;
    }
    
    if (activeTimeRange !== 'all') {
      const [start, end] = activeTimeRange.split('-').map(Number);
      const year = activeEvent === 'birth' ? parseInt(person.birthYear) : parseInt(person.deathYear);
      if (!year || year < start || year > end) {
        return false;
      }
    }
    
    return true;
  });
  
  const uniqueLocations = new Set();
  const uniqueCountries = new Set();
  
  filteredPeople.forEach(person => {
    if (activeEvent === 'all' || activeEvent === 'birth') {
      if (person.birthLat) {
        addMarker(person, 'birth');
        uniqueLocations.add(`${person.birthLat},${person.birthLng}`);
        if (person.birthCountry) uniqueCountries.add(person.birthCountry);
      }
    }
    
    if (activeEvent === 'all' || activeEvent === 'death') {
      if (person.deathLat) {
        addMarker(person, 'death');
        uniqueLocations.add(`${person.deathLat},${person.deathLng}`);
        if (person.deathCountry) uniqueCountries.add(person.deathCountry);
      }
    }
  });
  
  updateStats(uniqueLocations.size, filteredPeople.length, uniqueCountries.size);
}

function addMarker(person, type) {
  const lat = type === 'birth' ? person.birthLat : person.deathLat;
  const lng = type === 'birth' ? person.birthLng : person.deathLng;
  const place = type === 'birth' 
    ? [person.birthCity, person.birthState, person.birthCountry].filter(x => x).join(', ')
    : [person.deathCity, person.deathState, person.deathCountry].filter(x => x).join(', ');
  const year = type === 'birth' ? person.birthYear : person.deathYear;
  const color = type === 'birth' ? '#4a7c59' : '#8b3a3a';
  
  const marker = L.circleMarker([lat, lng], {
    radius: 8,
    fillColor: color,
    color: '#fff',
    weight: 2,
    fillOpacity: 0.8
  }).addTo(map);
  
  const name = [person.firstName, person.lastName].filter(x => x).join(' ');
  
  marker.bindPopup(`
    <div class="popup-title">${name}</div>
    <div class="popup-detail"><strong>${type === 'birth' ? 'Born' : 'Died'}:</strong> ${place}</div>
    <div class="popup-detail"><strong>Year:</strong> ${year || 'Unknown'}</div>
    ${person.branch ? `<div class="popup-detail"><strong>Branch:</strong> ${person.branch}</div>` : ''}
  `);
  
  markers.push(marker);
}

function updateStats(locations, people, countries) {
  document.getElementById('locationCount').textContent = locations || 0;
  document.getElementById('peopleCount').textContent = people || 0;
  document.getElementById('countryCount').textContent = countries || 0;
}

document.getElementById('branchFilter').addEventListener('change', (e) => {
  activeBranch = e.target.value;
  renderMap();
});

document.getElementById('eventFilter').addEventListener('change', (e) => {
  activeEvent = e.target.value;
  renderMap();
});

document.getElementById('timeFilter').addEventListener('change', (e) => {
  activeTimeRange = e.target.value;
  renderMap();
});

document.addEventListener('DOMContentLoaded', initMap);
</script>

</body>
</html>
