<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Owen Family ‚Äî How Am I Related?</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,500&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f0e8; --bg-card: #faf7f2; --bg-dark: #eee8db;
  --accent: #8b6914; --accent-light: #c4a44a; --accent-glow: rgba(139,105,20,0.12);
  --text: #2c2418; --text-muted: #6b5d4d; --text-light: #9a8b78;
  --border: #d9cdb8; --border-light: #e8dece;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

.home-nav{background:var(--bg-card);padding:8px 16px;border-bottom:1px solid var(--border);}
.home-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);text-decoration:none;font-size:0.8rem;font-weight:500;transition:all .2s;}
.home-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent);transform:translateY(-1px);}

.site-header{background:linear-gradient(135deg,#2c2418 0%,#3d3224 50%,#2c2418 100%);padding:2.5rem 2rem 2.2rem;position:relative;}
.site-header::before{content:'';position:absolute;inset:0;background:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");}
.header-content{max-width:900px;margin:0 auto;position:relative;z-index:1;}
.site-title{font-family:'Cormorant Garamond',serif;font-weight:300;font-size:2.6rem;color:#f5f0e8;}
.site-title span{color:var(--accent-light);font-weight:600;}
.site-subtitle{color:#9a8b78;font-size:1rem;margin-top:0.4rem;font-weight:300;}

.main-container{max-width:900px;margin:0 auto;padding:2rem;}

/* Selector panel */
.selector-panel{display:grid;grid-template-columns:1fr auto 1fr;gap:1rem;align-items:start;margin-bottom:2rem;}
.person-selector{background:var(--bg-card);border:1.5px solid var(--border);border-radius:14px;padding:1.5rem;transition:border-color 0.2s,box-shadow 0.2s;}
.person-selector.filled{border-color:var(--accent-light);box-shadow:0 2px 12px var(--accent-glow);}
.selector-label{font-family:'Cormorant Garamond',serif;font-size:1.1rem;font-weight:600;color:var(--text-muted);margin-bottom:0.6rem;}
.selector-search-wrapper{position:relative;}
.selector-search{width:100%;padding:0.65rem 0.9rem 0.65rem 2.4rem;font-family:'DM Sans',sans-serif;font-size:0.92rem;border:1.5px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text);outline:none;transition:border-color 0.2s;}
.selector-search:focus{border-color:var(--accent);}
.selector-search::placeholder{color:var(--text-light);}
.selector-search-icon{position:absolute;left:0.8rem;top:50%;transform:translateY(-50%);color:var(--text-light);pointer-events:none;}
.selector-dropdown{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--bg-card);border:1.5px solid var(--border);border-radius:10px;max-height:280px;overflow-y:auto;z-index:50;box-shadow:0 8px 30px rgba(44,36,24,0.15);display:none;}
.selector-dropdown.active{display:block;}
.selector-option{padding:0.6rem 0.9rem;cursor:pointer;border-bottom:1px solid var(--border-light);transition:background 0.12s;font-size:0.9rem;}
.selector-option:last-child{border-bottom:none;}
.selector-option:hover{background:var(--accent-glow);}
.selector-option .opt-name{font-weight:500;}
.selector-option .opt-meta{font-size:0.78rem;color:var(--text-muted);margin-top:0.1rem;}

.selected-person{margin-top:0.8rem;display:none;}
.selected-person.active{display:block;}
.sp-card{display:flex;gap:0.8rem;align-items:center;padding:0.8rem;background:var(--bg);border-radius:10px;}
.sp-icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;border:2px solid;}
.sp-icon.male{background:rgba(70,130,180,0.1);border-color:rgba(70,130,180,0.3);color:#4682b4;}
.sp-icon.female{background:rgba(180,100,130,0.1);border-color:rgba(180,100,130,0.3);color:#b46482;}
.sp-name{font-family:'Cormorant Garamond',serif;font-weight:600;font-size:1.1rem;color:var(--text);line-height:1.2;}
.sp-dates{font-size:0.82rem;color:var(--text-muted);}
.sp-clear{margin-left:auto;background:none;border:none;color:var(--text-light);cursor:pointer;font-size:1.1rem;padding:0.3rem;border-radius:4px;transition:color 0.15s;}
.sp-clear:hover{color:var(--text);}

.connector-column{display:flex;flex-direction:column;align-items:center;justify-content:center;padding-top:2.5rem;}
.connector-icon{width:48px;height:48px;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.4rem;box-shadow:0 4px 12px rgba(139,105,20,0.3);}
.swap-btn{margin-top:0.5rem;font-family:'DM Sans',sans-serif;font-size:0.72rem;padding:0.25rem 0.5rem;border:1px solid var(--border-light);border-radius:4px;background:transparent;color:var(--text-light);cursor:pointer;transition:all 0.15s;}
.swap-btn:hover{color:var(--accent);border-color:var(--accent);}

/* Find button */
.find-section{text-align:center;margin-bottom:2rem;}
.find-btn{font-family:'DM Sans',sans-serif;font-size:1rem;font-weight:600;padding:0.9rem 2.5rem;border:none;border-radius:12px;background:var(--accent);color:#fff;cursor:pointer;transition:all 0.2s;box-shadow:0 4px 16px rgba(139,105,20,0.25);}
.find-btn:hover{background:#a07a1a;transform:translateY(-1px);box-shadow:0 6px 20px rgba(139,105,20,0.35);}
.find-btn:disabled{opacity:0.4;cursor:not-allowed;transform:none;box-shadow:none;}

/* Results */
.result-section{display:none;}
.result-section.active{display:block;}

.result-statement{text-align:center;margin-bottom:2rem;padding:2rem;background:var(--bg-card);border:1px solid var(--border);border-radius:16px;box-shadow:0 4px 20px rgba(44,36,24,0.06);}
.result-statement-text{font-family:'Cormorant Garamond',serif;font-size:1.5rem;font-weight:500;color:var(--text);line-height:1.5;}
.result-statement-text strong{color:var(--accent);font-weight:700;}
.result-steps{font-size:0.88rem;color:var(--text-muted);margin-top:0.6rem;}

/* Path visualization */
.path-visual{position:relative;display:flex;flex-direction:column;align-items:center;gap:0;}

.path-node{display:flex;align-items:center;gap:1rem;width:100%;max-width:550px;z-index:2;}
.path-node.left .pn-card{margin-right:auto;}
.path-node.right .pn-card{margin-left:auto;}

.pn-card{background:var(--bg-card);border:1.5px solid var(--border);border-radius:12px;padding:1rem 1.3rem;max-width:380px;width:100%;transition:all 0.15s;cursor:pointer;position:relative;}
.pn-card:hover{border-color:var(--accent-light);box-shadow:0 4px 16px var(--accent-glow);}
.pn-card.endpoint{border-color:var(--accent);background:linear-gradient(135deg,var(--bg-card),#faf5e8);box-shadow:0 2px 12px var(--accent-glow);}
.pn-name{font-family:'Cormorant Garamond',serif;font-size:1.15rem;font-weight:600;color:var(--text);}
.pn-dates{font-size:0.82rem;color:var(--text-muted);margin-top:0.1rem;}
.pn-branch{display:inline-block;font-size:0.68rem;font-weight:600;padding:0.1rem 0.45rem;border-radius:3px;margin-top:0.3rem;text-transform:uppercase;letter-spacing:0.05em;}
.bp-Owen{background:rgba(184,134,11,0.15);color:#8b6914;}
.bp-Wells{background:rgba(70,130,180,0.15);color:#3a5f8b;}
.bp-Eastman{background:rgba(122,74,154,0.15);color:#6a3a8b;}
.bp-Bonnie{background:rgba(180,74,74,0.15);color:#8b3a3a;}
.bp-Lunde{background:rgba(74,154,154,0.15);color:#3a828b;}
.bp-Murphy{background:rgba(196,134,74,0.15);color:#8b6a3a;}
.bp-Nelson{background:rgba(74,154,106,0.15);color:#3a8b6a;}

.path-connector{width:2px;height:30px;background:linear-gradient(180deg,var(--border),var(--accent-light),var(--border));margin:0 auto;position:relative;z-index:1;}
.path-connector::before{content:'';position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:8px;height:8px;background:var(--accent);border-radius:50%;}

@media(max-width:768px){
  .site-title{font-size:2rem;}
  .selector-panel{grid-template-columns:1fr;gap:1rem;}
  .connector-column{padding:0.5rem;flex-direction:row;}
  .path-node{max-width:100%;}
  .pn-card{max-width:100%;}
}
</style>
<script src="data-loader.js"></script>
</head>
<body>

<div class="home-nav"><a href="index.html" class="home-btn">‚Üê Return to Home</a></div>

<header class="site-header">
  <div class="header-content">
    <h1 class="site-title">How Am I <span>Related?</span></h1>
    <p class="site-subtitle">Discover the connection between any two family members through our 500-year family tree</p>
  </div>
</header>

<main class="main-container">
  <!-- Person selectors -->
  <div class="selector-panel">
    <div class="person-selector" id="selectorA">
      <div class="selector-label">Person A</div>
      <div class="selector-search-wrapper">
        <svg class="selector-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" class="selector-search" id="searchA" placeholder="Search by name...">
        <div class="selector-dropdown" id="dropdownA"></div>
      </div>
      <div class="selected-person" id="selectedA"></div>
    </div>

    <div class="connector-column">
      <div class="connector-icon">‚ü∑</div>
      <button class="swap-btn" onclick="swapPeople()">‚áÑ Swap</button>
    </div>

    <div class="person-selector" id="selectorB">
      <div class="selector-label">Person B</div>
      <div class="selector-search-wrapper">
        <svg class="selector-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" class="selector-search" id="searchB" placeholder="Search by name...">
        <div class="selector-dropdown" id="dropdownB"></div>
      </div>
      <div class="selected-person" id="selectedB"></div>
    </div>
  </div>

  <!-- Find relationship button -->
  <div class="find-section">
    <button class="find-btn" id="findBtn" onclick="findRelationship()" disabled>Find Relationship</button>
  </div>

  <!-- Results -->
  <div class="result-section" id="resultSection">
    <div class="result-statement" id="resultStatement"></div>
    <div class="path-visual" id="pathVisual"></div>
  </div>
</main>

<script>
// ===== DATA LOADING =====
let PEOPLE = [];
const peopleMap = {};

async function initRelationshipFinder() {
  try {
    const db = owenFamilyDB;
    const data = await db.getData();
    
    if (!data.people || data.people.length === 0) {
      throw new Error('No records returned from database');
    }
    
    PEOPLE = data.people;
    PEOPLE.forEach(function(p){ peopleMap[p.id] = p; });
    
    buildGraph();
    setupSearch('searchA', 'dropdownA', 'selectedA', 'selectorA', 'A');
    setupSearch('searchB', 'dropdownB', 'selectedB', 'selectorB', 'B');
    
    // Pre-select Aurora Mae Owen and Nora Ann Murphy
    preSelectPeople();
    
  } catch (error) {
    console.error('Failed to load family data:', error);
    document.querySelector('.main-container').innerHTML = '<p style="color:var(--danger);text-align:center;">Unable to load family data. Please refresh the page.</p>';
  }
}

function preSelectPeople() {
  // Find Aurora Mae Owen
  var aurora = PEOPLE.find(function(p) {
    return p.firstName === 'Aurora' && p.lastName === 'Owen';
  });
  
  // Find Nora Ann Murphy
  var nora = PEOPLE.find(function(p) {
    return p.firstName === 'Nora' && p.lastName === 'Murphy';
  });
  
  if (aurora) selectPerson('A', aurora.id);
  if (nora) selectPerson('B', nora.id);
}

function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML;}

function formatDates(person) {
  var parts = [];
  if (person.birthYear) parts.push(person.birthYear);
  
  if (person.deathYear) {
    parts.push(person.deathYear);
  } else if (person.ageAtDeath === 'Alive') {
    parts.push('present');
  }
  
  return parts.join('‚Äì');
}

// ===== GRAPH BUILDING =====
var graph = {};
function buildGraph(){
PEOPLE.forEach(function(p){
  var pid = p.id;
  if(!graph[pid]) graph[pid] = [];

  if(p.fatherId && peopleMap[p.fatherId]){
    graph[pid].push({neighbor:p.fatherId, type:'parent', label:'father'});
    if(!graph[p.fatherId]) graph[p.fatherId]=[];
    graph[p.fatherId].push({neighbor:pid, type:'child', label:'child'});
  }
  if(p.motherId && peopleMap[p.motherId]){
    graph[pid].push({neighbor:p.motherId, type:'parent', label:'mother'});
    if(!graph[p.motherId]) graph[p.motherId]=[];
    graph[p.motherId].push({neighbor:pid, type:'child', label:'child'});
  }
  (p.spouseIds||[]).forEach(function(sid){
    if(peopleMap[sid]){
      graph[pid].push({neighbor:sid, type:'spouse', label:'spouse'});
      if(!graph[sid]) graph[sid]=[];
      graph[sid].push({neighbor:pid, type:'spouse', label:'spouse'});
    }
  });
  (p.childrenIds||[]).forEach(function(cid){
    if(peopleMap[cid]){
      graph[pid].push({neighbor:cid, type:'child', label:'child'});
      if(!graph[cid]) graph[cid]=[];
      graph[cid].push({neighbor:pid, type:'parent', label:'parent'});
    }
  });
  (p.siblingIds||[]).forEach(function(sid){
    if(peopleMap[sid]){
      graph[pid].push({neighbor:sid, type:'sibling', label:'sibling'});
      if(!graph[sid]) graph[sid]=[];
      graph[sid].push({neighbor:pid, type:'sibling', label:'sibling'});
    }
  });
});

// Deduplicate edges
Object.keys(graph).forEach(function(pid){
  var seen = {};
  graph[pid] = graph[pid].filter(function(e){
    var key = e.neighbor+'|'+e.type;
    if(seen[key]) return false;
    seen[key]=true; return true;
  });
});
}

// ===== BFS SHORTEST PATH =====
function bfsPath(startId, endId){
  if(startId === endId) return null; // same person
  if(!graph[startId] || !graph[endId]) return undefined; // not in graph

  var visited = {};
  visited[startId] = true;
  var queue = [{id:startId, path:[{id:startId, edgeType:null, edgeLabel:null}]}];
  var qi = 0;

  while(qi < queue.length){
    var curr = queue[qi++];
    var edges = graph[curr.id] || [];
    for(var i=0; i<edges.length; i++){
      var e = edges[i];
      if(visited[e.neighbor]) continue;
      visited[e.neighbor] = true;
      var newPath = curr.path.concat([{id:e.neighbor, edgeType:e.type, edgeLabel:e.label}]);
      if(e.neighbor === endId) return newPath;
      queue.push({id:e.neighbor, path:newPath});
    }
  }
  return undefined; // not connected
}

// ===== DESCRIBE RELATIONSHIP =====
function describeEdge(fromId, toId, edgeType){
  var from = peopleMap[fromId];
  var to = peopleMap[toId];
  if(edgeType === 'parent'){
    if(to.gender === 'M') return 'father';
    if(to.gender === 'F') return 'mother';
    return 'parent';
  }
  if(edgeType === 'child'){
    if(to.gender === 'M') return 'son';
    if(to.gender === 'F') return 'daughter';
    return 'child';
  }
  if(edgeType === 'spouse'){
    if(to.gender === 'M') return 'husband';
    if(to.gender === 'F') return 'wife';
    return 'spouse';
  }
  if(edgeType === 'sibling'){
    if(to.gender === 'M') return 'brother';
    if(to.gender === 'F') return 'sister';
    return 'sibling';
  }
  return edgeType;
}

function describeRelationship(path){
  if(!path || path.length < 2) return '';

  var startPerson = peopleMap[path[0].id];
  var endPerson = peopleMap[path[path.length-1].id];
  var startName = startPerson.firstName;
  var endName = endPerson.firstName;

  // Build edge sequence
  var edges = [];
  for(var i=1;i<path.length;i++){
    edges.push({
      from: path[i-1].id,
      to: path[i].id,
      type: path[i].edgeType,
      desc: describeEdge(path[i-1].id, path[i].id, path[i].edgeType)
    });
  }

  // Count parent/child steps to determine generational relationship
  var ups = 0;  // steps toward ancestors (parent edges)
  var downs = 0;  // steps toward descendants (child edges)
  var hasSpouse = false;
  var hasSibling = false;

  edges.forEach(function(e){
    if(e.type === 'parent') ups++;
    else if(e.type === 'child') downs++;
    else if(e.type === 'spouse') hasSpouse = true;
    else if(e.type === 'sibling') hasSibling = true;
  });

  // Build path description: "through X's father's mother's..."
  var through = edges.map(function(e){return e.desc;}).join("'s ");

  // Try to compute a standard relationship name
  var relName = '';

  if(ups === 0 && downs === 0 && hasSpouse && !hasSibling){
    relName = endPerson.gender==='M'?'husband':'wife';
  }
  else if(ups === 0 && downs === 0 && hasSibling && !hasSpouse){
    relName = endPerson.gender==='M'?'brother':'sister';
  }
  else if(ups === 1 && downs === 0 && !hasSpouse && !hasSibling){
    relName = endPerson.gender==='M'?'father':'mother';
  }
  else if(ups === 0 && downs === 1 && !hasSpouse && !hasSibling){
    relName = endPerson.gender==='M'?'son':'daughter';
  }
  else if(ups === 2 && downs === 0 && !hasSpouse && !hasSibling){
    relName = endPerson.gender==='M'?'grandfather':'grandmother';
  }
  else if(ups === 0 && downs === 2 && !hasSpouse && !hasSibling){
    relName = endPerson.gender==='M'?'grandson':'granddaughter';
  }
  else if(ups > 2 && downs === 0 && !hasSpouse && !hasSibling){
    var greats = ups - 2;
    var prefix = greats === 1 ? 'great-' : greats + '√ógreat-';
    relName = prefix + (endPerson.gender==='M'?'grandfather':'grandmother');
  }
  else if(ups === 0 && downs > 2 && !hasSpouse && !hasSibling){
    var greats2 = downs - 2;
    var prefix2 = greats2 === 1 ? 'great-' : greats2 + '√ógreat-';
    relName = prefix2 + (endPerson.gender==='M'?'grandson':'granddaughter');
  }
  else if(ups >= 1 && downs >= 1 && !hasSpouse){
    // Could be cousin, uncle/aunt, nephew/niece
    if(ups === 1 && downs === 2 && hasSibling){
      relName = endPerson.gender==='M'?'nephew':'niece';
    } else if(ups === 2 && downs === 1 && hasSibling){
      relName = endPerson.gender==='M'?'uncle':'aunt';
    } else if(ups === downs && hasSibling){
      // Fix: cousin degree calculation
      var cousinDeg = ups; // Should be ups, not ups - 1
      if(cousinDeg === 1) relName = 'first cousin';
      else if(cousinDeg === 2) relName = 'second cousin';
      else if(cousinDeg === 3) relName = 'third cousin';
      else relName = cousinDeg + 'th cousin';
    } else if(hasSibling && ups !== downs){
      var minGen = Math.min(ups,downs);
      var diff = Math.abs(ups-downs);
      var cousinD = minGen;
      if(cousinD >= 1){
        var cName = cousinD===1?'first':cousinD===2?'second':cousinD===3?'third':cousinD+'th';
        relName = cName + ' cousin ' + diff + '√óremoved';
      } else {
        // great-uncle/aunt or great-nephew/niece
        if(ups > downs){
          var gr = ups - downs - 1;
          var gPre = gr > 0 ? (gr===1?'great-':gr+'√ógreat-') : '';
          relName = gPre + (endPerson.gender==='M'?'uncle':'aunt');
        } else {
          var gr2 = downs - ups - 1;
          var gPre2 = gr2 > 0 ? (gr2===1?'great-':gr2+'√ógreat-') : '';
          relName = gPre2 + (endPerson.gender==='M'?'nephew':'niece');
        }
      }
    }
  }

  if(!relName) relName = 'related (' + (path.length-1) + ' steps)';

  return {
    relName: relName,
    through: through,
    edges: edges,
    ups: ups,
    downs: downs
  };
}

// ===== UI STATE =====
var personA = null;
var personB = null;

function setupSearch(inputId, dropdownId, selectedId, selectorId, which){
  var input = document.getElementById(inputId);
  var dropdown = document.getElementById(dropdownId);

  input.addEventListener('input', function(){
    var q = input.value.trim().toLowerCase();
    if(q.length < 2){ dropdown.classList.remove('active'); return; }
    var results = PEOPLE.filter(function(p){
      return [p.fullName,p.firstName,p.lastName,p.maidenName,String(p.birthYear)].join(' ').toLowerCase().indexOf(q)>=0;
    }).slice(0,12);

    if(!results.length){
      dropdown.innerHTML = '<div style="padding:0.8rem;color:var(--text-light);text-align:center;font-size:0.88rem;">No results</div>';
    } else {
      dropdown.innerHTML = results.map(function(p){
        var dates = formatDates(p);
        var loc = [p.birthCity,p.birthState].filter(Boolean).join(', ');
        return '<div class="selector-option" data-id="'+p.id+'"><div class="opt-name">'+esc(p.fullName||p.firstName+' '+p.lastName)+'</div><div class="opt-meta">'+dates+(loc?' ¬∑ '+loc:'')+(p.branchLineage?' ¬∑ '+p.branchLineage:'')+'</div></div>';
      }).join('');
    }
    dropdown.classList.add('active');
  });

  input.addEventListener('focus', function(){
    if(input.value.trim().length>=2) dropdown.classList.add('active');
  });

  dropdown.addEventListener('click', function(e){
    var opt = e.target.closest('.selector-option');
    if(!opt) return;
    var id = opt.getAttribute('data-id');
    selectPerson(which, id);
    dropdown.classList.remove('active');
    input.value = '';
  });

  document.addEventListener('click', function(e){
    if(!e.target.closest('#'+inputId) && !e.target.closest('#'+dropdownId)){
      dropdown.classList.remove('active');
    }
  });
}

function selectPerson(which, personId){
  var person = peopleMap[personId];
  if(!person) return;

  if(which === 'A') personA = person;
  else personB = person;

  var selectedDiv = document.getElementById('selected'+which);
  var icon = person.gender==='M'?'üë®':'üë©';
  var iconCls = person.gender==='M'?'male':'female';
  var dates = formatDates(person);

  selectedDiv.innerHTML = `
    <div class="sp-card">
      <div class="sp-icon ${iconCls}">${icon}</div>
      <div style="flex:1">
        <div class="sp-name">${esc(person.fullName||person.firstName+' '+person.lastName)}</div>
        <div class="sp-dates">${dates}</div>
      </div>
      <button class="sp-clear" onclick="clearPerson('${which}')">‚úï</button>
    </div>
  `;
  selectedDiv.classList.add('active');
  document.getElementById('selector'+which).classList.add('filled');

  updateFindButton();
  document.getElementById('resultSection').classList.remove('active');
}

function clearPerson(which){
  if(which === 'A') personA = null;
  else personB = null;
  document.getElementById('selected'+which).classList.remove('active');
  document.getElementById('selector'+which).classList.remove('filled');
  updateFindButton();
  document.getElementById('resultSection').classList.remove('active');
}

function swapPeople(){
  var temp = personA;
  personA = personB;
  personB = temp;

  if(personA) selectPerson('A', personA.id);
  else clearPerson('A');

  if(personB) selectPerson('B', personB.id);
  else clearPerson('B');
}

function updateFindButton(){
  var btn = document.getElementById('findBtn');
  btn.disabled = !personA || !personB;
}

// ===== FIND RELATIONSHIP =====
function findRelationship(){
  if(!personA || !personB) return;

  var path = bfsPath(personA.id, personB.id);

  if(path === null){
    // Same person
    document.getElementById('resultStatement').innerHTML = `
      <div class="result-statement-text">These are the <strong>same person</strong>!</div>
    `;
    document.getElementById('pathVisual').innerHTML = '';
    document.getElementById('resultSection').classList.add('active');
    return;
  }

  if(path === undefined){
    // Not connected
    document.getElementById('resultStatement').innerHTML = `
      <div class="result-statement-text"><strong>${esc(personA.firstName)}</strong> and <strong>${esc(personB.firstName)}</strong> are <strong>not connected</strong> in our family tree.</div>
      <div class="result-steps">They may be from different family branches or the connection data is incomplete.</div>
    `;
    document.getElementById('pathVisual').innerHTML = '';
    document.getElementById('resultSection').classList.add('active');
    return;
  }

  var rel = describeRelationship(path);

  document.getElementById('resultStatement').innerHTML = `
    <div class="result-statement-text"><strong>${esc(personB.firstName)}</strong> is <strong>${esc(personA.firstName)}</strong>'s <strong>${rel.relName}</strong></div>
    <div class="result-steps">${path.length-1} step${path.length-1!==1?'s':''} through ${rel.through}</div>
  `;

  renderPath(path);
  document.getElementById('resultSection').classList.add('active');
}

function renderPath(path){
  var html = '';
  for(var i=0;i<path.length;i++){
    var node = path[i];
    var person = peopleMap[node.id];
    var dates = formatDates(person);
    var isEndpoint = i===0 || i===path.length-1;
    var side = i%2===0?'left':'right';
    var branch = person.branchLineage ? '<span class="pn-branch bp-'+person.branchLineage+'">'+person.branchLineage+'</span>' : '';

    html += `
      <div class="path-node ${side}">
        <div class="pn-card ${isEndpoint?'endpoint':''}">
          <div class="pn-name">${esc(person.fullName||person.firstName+' '+person.lastName)}</div>
          <div class="pn-dates">${dates}</div>
          ${branch}
        </div>
      </div>
    `;

    if(i < path.length-1){
      html += '<div class="path-connector"></div>';
    }
  }
  document.getElementById('pathVisual').innerHTML = html;
}

// ===== INIT =====
initRelationshipFinder();
</script>
</body>
</html>
