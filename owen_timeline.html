<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Owen Family — Historical Timeline</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,500&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f0e8; --bg-card: #faf7f2; --bg-dark: #eee8db;
  --accent: #8b6914; --accent-light: #c4a44a; --accent-glow: rgba(139,105,20,0.12);
  --text: #2c2418; --text-muted: #6b5d4d; --text-light: #9a8b78;
  --border: #d9cdb8; --border-light: #e8dece;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}

.home-nav{background:var(--bg-card);padding:8px 16px;border-bottom:1px solid var(--border);}
.home-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);text-decoration:none;font-size:0.8rem;font-weight:500;transition:all .2s;}
.home-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent);transform:translateY(-1px);}

.site-header{background:linear-gradient(135deg,#2c2418 0%,#3d3224 50%,#2c2418 100%);padding:2rem 2rem 1.8rem;position:relative;z-index:50;}
.site-header::before{content:'';position:absolute;inset:0;background:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");}
.header-content{max-width:1400px;margin:0 auto;position:relative;z-index:1;}
.site-title{font-family:'Cormorant Garamond',serif;font-weight:300;font-size:2.4rem;color:#f5f0e8;letter-spacing:0.02em;}
.site-title span{color:var(--accent-light);font-weight:600;}
.site-subtitle{color:#9a8b78;font-size:0.95rem;margin-top:0.3rem;font-weight:300;}

.controls-bar{background:var(--bg-card);border-bottom:1px solid var(--border);padding:0.8rem 2rem;position:sticky;top:0;z-index:40;box-shadow:0 2px 8px rgba(44,36,24,0.06);}
.controls-inner{max-width:1400px;margin:0 auto;display:flex;align-items:center;gap:1rem;flex-wrap:wrap;}
.control-group{display:flex;align-items:center;gap:0.4rem;}
.control-label{font-size:0.78rem;color:var(--text-muted);font-weight:500;text-transform:uppercase;letter-spacing:0.05em;white-space:nowrap;}
select,.filter-btn{font-family:'DM Sans',sans-serif;font-size:0.85rem;padding:0.4rem 0.7rem;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);cursor:pointer;outline:none;}
select:focus,.filter-btn:focus{border-color:var(--accent);}
.filter-btn{transition:all 0.15s;}
.filter-btn.active{background:var(--accent);color:#fff;border-color:var(--accent);}
.filter-btn:hover:not(.active){background:var(--accent-glow);}
.zoom-controls{display:flex;align-items:center;gap:0.3rem;margin-left:auto;}
.zoom-btn{width:32px;height:32px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;}
.zoom-btn:hover{background:var(--accent-glow);border-color:var(--accent);}
.zoom-label{font-size:0.8rem;color:var(--text-muted);min-width:40px;text-align:center;}
.era-presets{display:flex;gap:0.3rem;}
.era-btn{font-family:'DM Sans',sans-serif;font-size:0.75rem;padding:0.3rem 0.6rem;border:1px solid var(--border-light);border-radius:4px;background:transparent;color:var(--text-muted);cursor:pointer;transition:all 0.15s;white-space:nowrap;}
.era-btn:hover{background:var(--accent-glow);border-color:var(--accent);color:var(--accent);}

.timeline-wrapper{position:relative;overflow-x:auto;overflow-y:auto;height:calc(100vh - 140px);cursor:grab;}
.timeline-wrapper:active{cursor:grabbing;}
.timeline-wrapper::-webkit-scrollbar{height:10px;width:10px;}
.timeline-wrapper::-webkit-scrollbar-track{background:var(--bg-dark);}
.timeline-wrapper::-webkit-scrollbar-thumb{background:var(--border);border-radius:5px;}
.timeline-wrapper::-webkit-scrollbar-thumb:hover{background:var(--accent-light);}
.timeline-canvas{position:relative;min-height:100%;}

.year-axis{position:sticky;top:0;z-index:20;height:48px;background:linear-gradient(180deg,var(--bg-card) 80%,transparent);pointer-events:none;}
.year-tick{position:absolute;top:0;height:48px;border-left:1px solid var(--border-light);font-size:0.75rem;color:var(--text-light);padding:4px 6px;font-weight:500;}
.year-tick.major{border-left:1px solid var(--border);color:var(--text-muted);font-weight:600;}
.year-tick.century{border-left:2px solid var(--accent-light);color:var(--accent);font-weight:700;font-size:0.85rem;}

.grid-line{position:absolute;top:48px;bottom:0;width:1px;pointer-events:none;}
.grid-line.minor{background:rgba(217,205,184,0.3);}
.grid-line.major{background:rgba(217,205,184,0.5);}
.grid-line.century{background:rgba(139,105,20,0.15);width:2px;}

.generation-divider{position:absolute;left:0;right:0;height:1px;background:var(--border-light);z-index:3;pointer-events:none;}

.hist-event{position:absolute;top:48px;z-index:5;pointer-events:auto;}
.hist-event-bar{height:100%;opacity:0.07;position:absolute;top:0;left:0;}
.hist-event-label{position:sticky;top:52px;font-size:0.68rem;font-weight:600;text-transform:uppercase;letter-spacing:0.06em;padding:2px 6px;border-radius:3px;white-space:nowrap;z-index:6;pointer-events:auto;}
.hist-event-label:hover{opacity:1!important;}
.hist-war{color:#8b3a3a;}
.hist-war .hist-event-bar{background:#8b3a3a;}
.hist-war .hist-event-label{background:rgba(139,58,58,0.12);}
.hist-era{color:#3a5f8b;}
.hist-era .hist-event-bar{background:#3a5f8b;}
.hist-era .hist-event-label{background:rgba(58,95,139,0.12);}
.hist-point{color:#6a3a8b;}
.hist-point .hist-event-label{background:rgba(106,58,139,0.12);}

.life-row{position:absolute;height:34px;display:flex;align-items:center;cursor:pointer;transition:all 0.2s;z-index:10;}
.life-row:hover{z-index:15;transform:translateY(-2px);}
.life-row.dimmed{opacity:0.15;}
.life-row.focused{opacity:1 !important;z-index:20;}
.life-bar{height:18px;border-radius:9px;position:relative;min-width:4px;transition:all 0.15s;box-shadow:0 2px 4px rgba(44,36,24,0.15);opacity:0.88;}
.life-row:hover .life-bar{height:22px;box-shadow:0 3px 10px rgba(44,36,24,0.3);filter:brightness(1.12);opacity:1;}
.life-label{font-size:0.75rem;font-weight:600;white-space:nowrap;padding-left:8px;color:var(--text-muted);pointer-events:none;transition:all 0.15s;}
.life-row:hover .life-label{color:var(--text);font-weight:700;}

.life-marker{position:absolute;width:10px;height:10px;border-radius:50%;top:50%;transform:translate(-50%,-50%);z-index:2;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,0.3);}
.marker-immigration{background:#3a828b;}
.marker-military-start{background:#8b3a3a;}

.branch-c-Owen{background:#b8860b;}
.branch-c-Wells{background:#4682b4;}
.branch-c-Wheeler{background:#5a8a6a;}
.branch-c-Bonnie{background:#b44a4a;}
.branch-c-Eastman{background:#7a4a9a;}
.branch-c-Lunde{background:#4a9a9a;}
.branch-c-Murphy{background:#c4864a;}
.branch-c-Nelson{background:#4a9a6a;}
.branch-c-default{background:#8a7a6a;}

.detail-popup{position:fixed;z-index:100;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 40px rgba(44,36,24,0.2);max-width:380px;width:380px;display:none;overflow:hidden;}
.detail-popup.active{display:block;}
.detail-popup-header{padding:1rem 1.2rem 0.8rem;background:linear-gradient(135deg,#2c2418,#3d3224);color:#f5f0e8;}
.detail-popup-name{font-family:'Cormorant Garamond',serif;font-size:1.2rem;font-weight:600;}
.detail-popup-dates{font-size:0.85rem;color:var(--accent-light);margin-top:0.15rem;}
.detail-popup-body{padding:1rem 1.2rem;font-size:0.85rem;max-height:280px;overflow-y:auto;}
.detail-popup-body .field{display:flex;justify-content:space-between;padding:0.25rem 0;border-bottom:1px solid var(--border-light);}
.detail-popup-body .field:last-child{border-bottom:none;}
.detail-popup-body .fl{color:var(--text-muted);}
.detail-popup-body .fv{color:var(--text);font-weight:500;text-align:right;max-width:58%;}
.detail-popup-close{position:absolute;top:0.6rem;right:0.8rem;background:none;border:none;color:#9a8b78;font-size:1.2rem;cursor:pointer;z-index:5;}
.detail-popup-close:hover{color:#f5f0e8;}
.detail-popup-notes{margin-top:0.5rem;padding:0.6rem;background:var(--bg);border-radius:6px;font-size:0.82rem;line-height:1.5;color:var(--text-muted);border-left:3px solid var(--accent);max-height:100px;overflow-y:auto;}

.legend{position:fixed;bottom:1rem;right:1rem;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:0.8rem 1rem;z-index:30;box-shadow:0 4px 16px rgba(44,36,24,0.1);font-size:0.75rem;max-width:200px;}
.legend-title{font-family:'Cormorant Garamond',serif;font-weight:600;font-size:0.9rem;margin-bottom:0.4rem;color:var(--accent);}
.legend-item{display:flex;align-items:center;gap:0.4rem;padding:0.15rem 0;color:var(--text-muted);}
.legend-swatch{width:16px;height:8px;border-radius:4px;flex-shrink:0;}
.legend-marker-row{display:flex;align-items:center;gap:0.4rem;padding:0.2rem 0;color:var(--text-muted);margin-top:0.3rem;padding-top:0.3rem;border-top:1px solid var(--border-light);}
.legend-marker{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.legend-toggle{margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid var(--border-light);}
.legend-toggle button{font-family:'DM Sans',sans-serif;font-size:0.72rem;padding:0.2rem 0.5rem;border:1px solid var(--border-light);border-radius:4px;background:transparent;color:var(--text-muted);cursor:pointer;}
.legend-toggle button:hover{background:var(--accent-glow);}

.stats-bar{position:fixed;bottom:1rem;left:1rem;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:0.6rem 1rem;z-index:30;box-shadow:0 4px 16px rgba(44,36,24,0.1);font-size:0.78rem;color:var(--text-muted);display:flex;gap:1.2rem;}
.stat-item strong{color:var(--accent);}

.loading{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:200;background:var(--bg-card);padding:2rem;border-radius:10px;border:1px solid var(--border);}
.loading-spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 1rem;}
@keyframes spin{to{transform:rotate(360deg);}}

@media(max-width:768px){
  .controls-inner{gap:0.5rem;}
  .era-presets{display:none;}
  .legend{display:none;}
  .site-title{font-size:1.8rem;}
  .stats-bar{gap:0.6rem;font-size:0.7rem;}
}
</style>
<script src="data-loader.js"></script>
</head>
<body>

<div class="home-nav"><a href="index.html" class="home-btn">← Return to Home</a></div>

<header class="site-header">
  <div class="header-content">
    <h1 class="site-title">Owen Family <span>Timeline</span></h1>
    <p class="site-subtitle">765 years of family history against the sweep of world events</p>
  </div>
</header>

<div class="controls-bar">
  <div class="controls-inner">
    <div class="control-group">
      <span class="control-label">Branch</span>
      <select id="branchFilter">
        <option value="all">All Branches</option>
        <option value="Owen">Owen</option>
        <option value="Wells">Wells</option>
        <option value="Bonnie">Bonnie</option>
        <option value="Eastman">Eastman</option>
        <option value="Lunde">Lunde</option>
        <option value="Murphy">Murphy</option>
        <option value="Nelson">Nelson</option>
      </select>
    </div>
    <div class="control-group">
      <span class="control-label">Show</span>
      <button class="filter-btn active" data-filter="lifespans" onclick="toggleFilter(this)">Lifespans</button>
      <button class="filter-btn active" data-filter="military" onclick="toggleFilter(this)">Military</button>
      <button class="filter-btn active" data-filter="immigration" onclick="toggleFilter(this)">Immigration</button>
      <button class="filter-btn active" data-filter="events" onclick="toggleFilter(this)">History</button>
      <button class="filter-btn" data-filter="generations" onclick="toggleFilter(this)">Generations</button>
    </div>
    <div class="era-presets">
      <button class="era-btn" onclick="scrollToEra(1250,1500)">Medieval</button>
      <button class="era-btn" onclick="scrollToEra(1600,1700)">Colonial</button>
      <button class="era-btn" onclick="scrollToEra(1750,1800)">Revolution</button>
      <button class="era-btn" onclick="scrollToEra(1840,1880)">Civil War</button>
      <button class="era-btn" onclick="scrollToEra(1900,1960)">World Wars</button>
      <button class="era-btn" onclick="scrollToEra(1950,2026)">Modern</button>
      <button class="era-btn" onclick="scrollToEra(1250,2030)">Full Span</button>
    </div>
    <div class="zoom-controls">
      <button class="zoom-btn" onclick="zoomTimeline(-1)">−</button>
      <span class="zoom-label" id="zoomLabel">100%</span>
      <button class="zoom-btn" onclick="zoomTimeline(1)">+</button>
    </div>
  </div>
</div>

<div class="timeline-wrapper" id="timelineWrapper">
  <div class="timeline-canvas" id="timelineCanvas">
    <div class="year-axis" id="yearAxis"></div>
    <div id="gridLines"></div>
    <div id="generationDividers"></div>
    <div id="histEvents"></div>
    <div id="lifeRows"></div>
  </div>
</div>

<div class="loading" id="loading">
  <div class="loading-spinner"></div>
  <p>Loading family data from Google Sheets...</p>
</div>

<div class="detail-popup" id="detailPopup">
  <button class="detail-popup-close" onclick="closePopup()">&#10005;</button>
  <div class="detail-popup-header" id="popupHeader"></div>
  <div class="detail-popup-body" id="popupBody"></div>
</div>

<div class="legend" id="legend">
  <div class="legend-title">Branches</div>
  <div id="legendItems"></div>
  <div class="legend-marker-row"><div class="legend-marker" style="background:#3a828b"></div> Immigration</div>
  <div class="legend-marker-row"><div class="legend-marker" style="background:#8b3a3a"></div> Military Service</div>
  <div class="legend-toggle">
    <button onclick="document.getElementById('legend').style.display='none'">Hide Legend</button>
  </div>
</div>

<div class="stats-bar" id="statsBar"></div>

<script>
const HIST_EVENTS = [
  {name:"Hundred Years' War",start:1337,end:1453,type:"war"},
  {name:"War of the Roses",start:1455,end:1487,type:"war"},
  {name:"English Civil War",start:1642,end:1651,type:"war"},
  {name:"King Philip's War",start:1675,end:1678,type:"war"},
  {name:"Pequot War",start:1636,end:1638,type:"war"},
  {name:"American Revolution",start:1775,end:1783,type:"war"},
  {name:"War of 1812",start:1812,end:1815,type:"war"},
  {name:"US Civil War",start:1861,end:1865,type:"war"},
  {name:"World War I",start:1914,end:1918,type:"war"},
  {name:"World War II",start:1939,end:1945,type:"war"},
  {name:"Korean War",start:1950,end:1953,type:"war"},
  {name:"Vietnam War",start:1955,end:1975,type:"war"},
  {name:"Black Death",start:1347,end:1353,type:"era"},
  {name:"Protestant Reformation",start:1517,end:1555,type:"era"},
  {name:"Mayflower 1620",start:1620,end:1621,type:"point"},
  {name:"Salem Witch Trials",start:1692,end:1693,type:"era"},
  {name:"Industrial Revolution",start:1760,end:1840,type:"era"},
  {name:"California Gold Rush",start:1848,end:1855,type:"era"},
  {name:"Great Depression",start:1929,end:1939,type:"era"},
  {name:"Westward Expansion",start:1803,end:1860,type:"era"}
];

const MIN_YEAR = 1250;
const MAX_YEAR = 2030;
const ROW_HEIGHT = 34;
const BASE_PX_PER_YEAR = 8;
let pxPerYear = BASE_PX_PER_YEAR;
let zoomLevel = 1;
const ZOOM_STEPS = [0.25, 0.35, 0.5, 0.7, 1, 1.4, 2, 3, 4, 6];
let zoomIndex = 4;

const filters = {lifespans:true, military:true, immigration:true, events:true, generations:false};
let activeBranch = 'all';
let focusedPersonId = null;

const branchColors = {
  Owen:'#b8860b', Wells:'#4682b4', Bonnie:'#b44a4a',
  Eastman:'#7a4a9a', Lunde:'#4a9a9a', Murphy:'#c4864a', Nelson:'#4a9a6a'
};

let PEOPLE = [];
const peopleMap = {};
let sortedPeople = [];

function yearToX(year){ return (year - MIN_YEAR) * pxPerYear; }
function xToYear(x){ return MIN_YEAR + x / pxPerYear; }
function esc(s){ var d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

async function init(){
  try {
    const db = owenFamilyDB;
    const data = await db.getData();
    
    if (!data.people || data.people.length === 0) {
      throw new Error('No records returned from database');
    }
    
    PEOPLE = data.people;
    PEOPLE.forEach(function(p){ peopleMap[p.id] = p; });
    
    sortedPeople = PEOPLE.filter(function(p){return p.birthYear;}).sort(function(a,b){
      if(a.birthYear !== b.birthYear) return a.birthYear - b.birthYear;
      return (a.branchLineage||'').localeCompare(b.branchLineage||'');
    });

    document.getElementById('branchFilter').addEventListener('change', function(e){
      activeBranch = e.target.value;
      render();
    });

    var wrapper = document.getElementById('timelineWrapper');
    var isDragging=false, startX, startY, scrollL, scrollT;

    wrapper.addEventListener('mousedown', function(e){
      if(e.target.closest('.life-row')||e.target.closest('.detail-popup')||e.target.closest('.hist-event-label')) return;
      isDragging=true;
      startX = e.pageX - wrapper.offsetLeft;
      startY = e.pageY - wrapper.offsetTop;
      scrollL = wrapper.scrollLeft;
      scrollT = wrapper.scrollTop;
    });
    wrapper.addEventListener('mouseleave', function(){isDragging=false;});
    wrapper.addEventListener('mouseup', function(){isDragging=false;});
    wrapper.addEventListener('mousemove', function(e){
      if(!isDragging) return;
      e.preventDefault();
      wrapper.scrollLeft = scrollL - (e.pageX - wrapper.offsetLeft - startX);
      wrapper.scrollTop = scrollT - (e.pageY - wrapper.offsetTop - startY);
    });

    wrapper.addEventListener('wheel', function(e){
      if(e.ctrlKey || e.metaKey){
        e.preventDefault();
        var dir = e.deltaY < 0 ? 1 : -1;
        var rect = wrapper.getBoundingClientRect();
        var mouseX = e.clientX - rect.left + wrapper.scrollLeft;
        var yearAtMouse = xToYear(mouseX);
        zoomTimeline(dir);
        wrapper.scrollLeft = yearToX(yearAtMouse) - (e.clientX - rect.left);
      }
    }, {passive:false});

    buildLegend();
    document.getElementById('loading').style.display = 'none';
    render();
    
    // Fit to width on initial load
    setTimeout(function(){ 
      var wrapper = document.getElementById('timelineWrapper');
      var viewWidth = wrapper.clientWidth;
      var totalYears = MAX_YEAR - MIN_YEAR; // 780 years
      var neededPPY = (viewWidth - 100) / totalYears; // Leave some margin
      
      // Find closest zoom level
      var bestIdx = 0, bestDiff = Infinity;
      for(var i = 0; i < ZOOM_STEPS.length; i++){
        var ppyr = BASE_PX_PER_YEAR * ZOOM_STEPS[i];
        var diff = Math.abs(ppyr - neededPPY);
        if(diff < bestDiff){ bestDiff = diff; bestIdx = i; }
      }
      
      zoomIndex = bestIdx;
      zoomLevel = ZOOM_STEPS[zoomIndex];
      pxPerYear = BASE_PX_PER_YEAR * zoomLevel;
      document.getElementById('zoomLabel').textContent = Math.round(zoomLevel*100)+'%';
      render();
      wrapper.scrollLeft = 0; // Start at beginning
    }, 100);
    
  } catch (error) {
    console.error('Failed to load family data:', error);
    document.getElementById('loading').innerHTML = `
      <div>
        <h2 style="color: var(--accent); margin-bottom: 0.5rem;">Unable to Load Family Data</h2>
        <p>Could not connect to the Google Sheets database.</p>
        <p style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--text-muted);">${error.message}</p>
        <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--accent); color: #fff; border: none; border-radius: 6px; cursor: pointer;">Retry</button>
      </div>
    `;
  }
}

function buildLegend(){
  var items = document.getElementById('legendItems');
  var html = '';
  for(var name in branchColors){
    html += '<div class="legend-item"><div class="legend-swatch" style="background:'+branchColors[name]+'"></div>'+name+'</div>';
  }
  items.innerHTML = html;
}

function render(){
  var totalWidth = (MAX_YEAR - MIN_YEAR) * pxPerYear + 200;
  var visible = sortedPeople;
  if(activeBranch !== 'all'){
    visible = visible.filter(function(p){ return p.branchLineage === activeBranch; });
  }
  var totalHeight = visible.length * ROW_HEIGHT + 120;
  var canvas = document.getElementById('timelineCanvas');
  canvas.style.width = totalWidth + 'px';
  canvas.style.height = Math.max(totalHeight, 600) + 'px';
  renderAxis(totalWidth);
  renderGridLines(totalWidth, totalHeight);
  if(filters.generations) renderGenerationDividers(visible);
  else document.getElementById('generationDividers').innerHTML = '';
  if(filters.events) renderHistEvents(totalHeight);
  else document.getElementById('histEvents').innerHTML = '';
  renderLifespans(visible);
  updateStats(visible);
}

function renderAxis(totalWidth){
  var axis = document.getElementById('yearAxis');
  axis.style.width = totalWidth + 'px';
  var html = '';
  var step = pxPerYear >= 6 ? 10 : pxPerYear >= 3 ? 25 : pxPerYear >= 1.5 ? 50 : 100;
  for(var y = Math.ceil(MIN_YEAR/step)*step; y <= MAX_YEAR; y += step){
    var x = yearToX(y);
    var isCentury = y % 100 === 0;
    var isMajor = y % 50 === 0;
    var cls = isCentury ? 'century' : isMajor ? 'major' : '';
    html += '<div class="year-tick '+cls+'" style="left:'+x+'px">'+y+'</div>';
  }
  axis.innerHTML = html;
}

function renderGridLines(totalWidth, totalHeight){
  var grid = document.getElementById('gridLines');
  var html = '';
  var step = pxPerYear >= 6 ? 10 : pxPerYear >= 3 ? 25 : pxPerYear >= 1.5 ? 50 : 100;
  for(var y = Math.ceil(MIN_YEAR/step)*step; y <= MAX_YEAR; y += step){
    var x = yearToX(y);
    var isCentury = y%100===0;
    var isMajor = y%50===0;
    var cls = isCentury ? 'century' : isMajor ? 'major' : 'minor';
    html += '<div class="grid-line '+cls+'" style="left:'+x+'px;height:'+totalHeight+'px"></div>';
  }
  grid.innerHTML = html;
}

function renderGenerationDividers(visible){
  var cont = document.getElementById('generationDividers');
  var html = '';
  var lastGen = null;
  for(var i=0; i<visible.length; i++){
    var gen = visible[i].generationNumber;
    if(gen != null && gen !== lastGen && lastGen !== null){
      var y = 60 + i * ROW_HEIGHT - 1;
      html += '<div class="generation-divider" style="top:'+y+'px"></div>';
    }
    if(gen != null) lastGen = gen;
  }
  cont.innerHTML = html;
}

function renderHistEvents(totalHeight){
  var cont = document.getElementById('histEvents');
  var html = '';
  HIST_EVENTS.forEach(function(ev){
    var x1 = yearToX(ev.start);
    var w = Math.max(ev.type==='point' ? 3 : (ev.end-ev.start)*pxPerYear, 3);
    var cls = ev.type==='war' ? 'hist-war' : ev.type==='era' ? 'hist-era' : 'hist-point';
    html += '<div class="hist-event '+cls+'" style="left:'+x1+'px;width:'+w+'px;height:'+(totalHeight-48)+'px">';
    html += '<div class="hist-event-bar" style="width:100%;height:100%"></div>';
    html += '<div class="hist-event-label">'+ev.name+'</div>';
    html += '</div>';
  });
  cont.innerHTML = html;
}

function renderLifespans(visible){
  var cont = document.getElementById('lifeRows');
  if(!filters.lifespans){ cont.innerHTML=''; return; }
  var html = '';
  for(var i=0; i<visible.length; i++){
    var p = visible[i];
    var startYear = p.birthYear;
    var endYear = p.deathYear || (p.ageAtDeath==='Alive' ? 2025 : (p.birthYear + 70));
    if(endYear < startYear) endYear = startYear + 1;
    var x = yearToX(startYear);
    var w = Math.max((endYear - startYear)*pxPerYear, 4);
    var y = 60 + i * ROW_HEIGHT;
    var brCls = 'branch-c-' + (p.branchLineage || 'default');
    var isAlive = p.ageAtDeath === 'Alive';
    var style = isAlive ? 'border-radius:9px 2px 2px 9px;' : '';
    var dimCls = focusedPersonId && focusedPersonId !== p.id ? 'dimmed' : '';
    var focusCls = focusedPersonId === p.id ? 'focused' : '';
    var markers = '';
    if(filters.immigration && p.immigrationYear){
      var iy = parseInt(p.immigrationYear);
      if(!isNaN(iy)){
        var mx = (iy - startYear)*pxPerYear;
        markers += '<div class="life-marker marker-immigration" style="left:'+mx+'px" title="Immigrated '+p.immigrationYear+'"></div>';
      }
    }
    if(filters.military && p.servedFrom){
      var sy = parseInt(p.servedFrom);
      if(!isNaN(sy)){
        var mmx = (sy - startYear)*pxPerYear;
        markers += '<div class="life-marker marker-military-start" style="left:'+mmx+'px" title="Military service '+p.servedFrom+'"></div>';
      }
    }
    var label = pxPerYear >= 2 ? (p.firstName + (pxPerYear >= 4 ? ' '+(p.lastName||'') : '')) : '';
    html += '<div class="life-row '+dimCls+' '+focusCls+'" style="left:'+x+'px;top:'+y+'px;width:'+(w+160)+'px" data-id="'+p.id+'" onclick="showPopup(event,this.dataset.id)">';
    html += '<div class="life-bar '+brCls+'" style="width:'+w+'px;'+style+'">'+markers+'</div>';
    html += '<span class="life-label">'+esc(label)+'</span>';
    html += '</div>';
  }
  cont.innerHTML = html;
}

function updateStats(visible){
  var alive = visible.filter(function(p){return p.ageAtDeath==='Alive';}).length;
  var mil = visible.filter(function(p){return p.military;}).length;
  var imm = visible.filter(function(p){return p.immigrationYear;}).length;
  var earliest = visible.length ? visible[0].birthYear : '?';
  var latest = visible.length ? visible[visible.length-1].birthYear : '?';
  document.getElementById('statsBar').innerHTML =
    '<span class="stat-item"><strong>'+visible.length+'</strong> people</span>'+
    '<span class="stat-item"><strong>'+earliest+'\u2013'+latest+'</strong></span>'+
    '<span class="stat-item"><strong>'+alive+'</strong> living</span>'+
    '<span class="stat-item"><strong>'+mil+'</strong> served</span>'+
    '<span class="stat-item"><strong>'+imm+'</strong> immigrants</span>';
}

function toggleFilter(btn){
  var key = btn.getAttribute('data-filter');
  filters[key] = !filters[key];
  btn.classList.toggle('active');
  render();
}

function zoomTimeline(dir){
  zoomIndex = Math.max(0, Math.min(ZOOM_STEPS.length-1, zoomIndex+dir));
  zoomLevel = ZOOM_STEPS[zoomIndex];
  pxPerYear = BASE_PX_PER_YEAR * zoomLevel;
  document.getElementById('zoomLabel').textContent = Math.round(zoomLevel*100)+'%';
  render();
}

function scrollToEra(startYear, endYear){
  var wrapper = document.getElementById('timelineWrapper');
  var viewWidth = wrapper.clientWidth;
  var neededPPY = viewWidth / (endYear - startYear + 20);
  var bestIdx=0, bestDiff=Infinity;
  for(var i=0;i<ZOOM_STEPS.length;i++){
    var ppyr = BASE_PX_PER_YEAR * ZOOM_STEPS[i];
    var diff = Math.abs(ppyr - neededPPY);
    if(diff < bestDiff){ bestDiff=diff; bestIdx=i; }
  }
  zoomIndex = bestIdx;
  zoomLevel = ZOOM_STEPS[zoomIndex];
  pxPerYear = BASE_PX_PER_YEAR * zoomLevel;
  document.getElementById('zoomLabel').textContent = Math.round(zoomLevel*100)+'%';
  render();
  wrapper.scrollLeft = Math.max(0, yearToX(startYear) - 40);
  wrapper.scrollTop = 0;
}

function showPopup(event, id){
  event.stopPropagation();
  focusedPersonId = id;
  render();
  
  var p = peopleMap[id];
  if(!p) return;
  var popup = document.getElementById('detailPopup');
  var dates = [];
  if(p.birthYear) dates.push('b. '+p.birthYear);
  if(p.deathYear) dates.push('d. '+p.deathYear);
  else if(p.ageAtDeath==='Alive') dates.push('living');
  var loc = [p.birthCity,p.birthState,p.birthCountry].filter(Boolean).join(', ');
  document.getElementById('popupHeader').innerHTML =
    '<div class="detail-popup-name">'+esc(p.fullName||p.firstName+' '+p.lastName)+'</div>'+
    '<div class="detail-popup-dates">'+dates.join(' \u00b7 ')+(loc?' \u00b7 '+esc(loc):'')+'</div>';
  var fields = [];
  if(p.branchLineage) fields.push(['Branch',p.branchLineage]);
  if(p.birthYear) fields.push(['Born',p.birthYear+(p.birthCity?', '+p.birthCity:'')]);
  if(p.deathYear) fields.push(['Died',p.deathYear+(p.deathCity?', '+p.deathCity:'')]);
  if(p.ageAtDeath&&p.ageAtDeath!=='Alive') fields.push(['Age',p.ageAtDeath]);
  if(p.fatherId&&peopleMap[p.fatherId]) fields.push(['Father',(peopleMap[p.fatherId].fullName||peopleMap[p.fatherId].firstName)]);
  if(p.motherId&&peopleMap[p.motherId]) fields.push(['Mother',(peopleMap[p.motherId].fullName||peopleMap[p.motherId].firstName)]);
  if(p.military) fields.push(['Military',[p.militaryBranch,p.war].filter(Boolean).join(', ')]);
  if(p.immigrationYear) fields.push(['Immigrated',p.immigrationYear]);
  if(p.occupation) fields.push(['Occupation',p.occupation]);
  if(p.generationNumber!=null) fields.push(['Generation','Gen '+p.generationNumber+' from Aurora']);
  var bodyHtml = fields.map(function(f){return '<div class="field"><span class="fl">'+f[0]+'</span><span class="fv">'+esc(String(f[1]))+'</span></div>';}).join('');
  if(p.notes){
    var tn = p.notes.length > 250 ? p.notes.substring(0,250)+'\u2026' : p.notes;
    bodyHtml += '<div class="detail-popup-notes">'+esc(tn)+'</div>';
  }
  document.getElementById('popupBody').innerHTML = bodyHtml;
  var left = event.clientX + 12;
  var top = event.clientY - 30;
  if(left+390 > window.innerWidth) left = event.clientX - 390;
  if(top+350 > window.innerHeight) top = window.innerHeight - 360;
  if(top < 10) top = 10;
  popup.style.left = left+'px';
  popup.style.top = top+'px';
  popup.classList.add('active');
}

function closePopup(){
  document.getElementById('detailPopup').classList.remove('active');
  focusedPersonId = null;
  render();
}

document.addEventListener('click', function(e){
  if(!e.target.closest('.detail-popup')&&!e.target.closest('.life-row')){
    closePopup();
  }
});

init();
</script>
</body>
</html>
